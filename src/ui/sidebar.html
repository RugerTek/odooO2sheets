<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <style>
      :root {
        --bg: #f8fafc;
        --panel: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --line: rgba(15, 23, 42, 0.12);
        --accent: #16a34a;
        --danger: #dc2626;
        --info: #2563eb;
      }
      html, body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font: 13px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      .wrap { padding: 12px; }
      h1 { font-size: 14px; margin: 0 0 8px; }
      h2 { font-size: 12px; margin: 0 0 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
      h3 { font-size: 12px; margin: 12px 0 8px; }

      .topLoader { position: sticky; top: 0; z-index: 999; height: 3px; background: transparent; }
      .topLoaderBar { height: 3px; width: 35%; background: rgba(37,99,235,0.9); border-radius: 999px; transform: translateX(-120%); opacity: 0; }
      body.loading .topLoaderBar { opacity: 1; animation: indeterminate 1.15s infinite; }
      @keyframes indeterminate {
        0% { transform: translateX(-120%); width: 25%; }
        50% { transform: translateX(120%); width: 45%; }
        100% { transform: translateX(260%); width: 25%; }
      }

      .card {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .row { display: flex; gap: 8px; align-items: center; }
      .row.wrap { flex-wrap: wrap; }
      .col { flex: 1; }
      .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .sep { height: 1px; background: var(--line); margin: 10px 0; }

      label { display: block; color: var(--muted); margin: 6px 0 2px; font-size: 12px; }
      input, select, textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        background: #fff;
        border: 1px solid rgba(15, 23, 42, 0.18);
        border-radius: 8px;
        color: var(--text);
        outline: none;
      }
      textarea { resize: vertical; min-height: 64px; }
      input::placeholder, textarea::placeholder { color: rgba(15,23,42,0.35); }

      button {
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      button.primary { border-color: rgba(22,163,74,0.35); background: rgba(22,163,74,0.10); }
      button.danger { border-color: rgba(220,38,38,0.35); background: rgba(220,38,38,0.08); }
      button:disabled { opacity: 0.55; cursor: not-allowed; }

      .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
      .full { flex: 1 1 100%; }
      .msg { margin-top: 8px; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--line); background: rgba(15,23,42,0.02); }
      .msg.ok { border-color: rgba(22,163,74,0.35); }
      .msg.err { border-color: rgba(220,38,38,0.35); }

      .list { display: flex; flex-direction: column; gap: 8px; }
      .item { padding: 8px 10px; border: 1px solid var(--line); border-radius: 10px; background: rgba(15,23,42,0.02); }
      .title { font-weight: 600; }
      .meta { color: var(--muted); font-size: 12px; margin-top: 2px; }
      .title, .meta, .hint { word-break: break-word; }
      .pill { display: inline-flex; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--line); color: var(--muted); font-size: 12px; }
      .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; border: 1px solid var(--line); padding: 1px 6px; border-radius: 7px; background: rgba(15,23,42,0.02); }
      .iconBtn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        padding: 0;
        border-radius: 10px;
      }
      .iconBtn svg { width: 18px; height: 18px; }
      .dsCard {
        display: grid;
        grid-template-columns: 44px 1fr auto;
        gap: 10px;
        align-items: start;
      }
      .dsIcon {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: linear-gradient(180deg, rgba(22,163,74,0.10), rgba(37,99,235,0.06));
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(15, 23, 42, 0.7);
        font-weight: 800;
      }
      .dsActions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .dsRow {
        display: grid;
        grid-template-columns: 38px 1fr auto;
        gap: 10px;
        align-items: center;
        cursor: pointer;
      }
      .dsRow:hover { background: rgba(15,23,42,0.03); }
      .dsRowIcon {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: linear-gradient(180deg, rgba(22,163,74,0.10), rgba(37,99,235,0.06));
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(15, 23, 42, 0.7);
        font-weight: 900;
        font-size: 12px;
      }
      .menuWrap { position: relative; display: inline-flex; gap: 6px; }
      .menuBtn { width: 34px; height: 34px; padding: 0; border-radius: 10px; }
      .menu {
        position: absolute;
        top: 38px;
        right: 0;
        z-index: 50;
        min-width: 190px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.10);
        padding: 6px;
      }
      .menuItem {
        width: 100%;
        text-align: left;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid transparent;
        background: transparent;
        color: var(--text);
        cursor: pointer;
      }
      .menuItem:hover { background: rgba(15,23,42,0.04); border-color: rgba(15,23,42,0.10); }
      .menuItem.danger { color: #991b1b; }
      .detailTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .detailTitle { font-weight: 800; font-size: 14px; }
      .detailActions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
      .statusPill { font-weight: 700; }
      .statusPill.ok { color: #166534; border-color: rgba(22,163,74,0.35); background: rgba(22,163,74,0.08); }
      .statusPill.err { color: #991b1b; border-color: rgba(220,38,38,0.35); background: rgba(220,38,38,0.08); }

      .status {
        display: none;
        margin: 8px 0 10px;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #fff;
      }
      .status.show { display: block; }
      .status.ok { border-color: rgba(22,163,74,0.35); }
      .status.err { border-color: rgba(220,38,38,0.35); }
      .status.info { border-color: rgba(37,99,235,0.35); }
      .status .row { justify-content: space-between; }
      .status .small { color: var(--muted); font-size: 12px; margin-top: 2px; }

      .pills { display: flex; flex-wrap: wrap; gap: 6px; }

      .tabs { display: flex; gap: 8px; margin: 8px 0 10px; }
      .tabBtn {
        flex: 1;
        text-align: center;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #fff;
        color: var(--muted);
        cursor: pointer;
        font-weight: 600;
      }
      .tabBtn.active {
        color: #166534;
        border-color: rgba(22,163,74,0.35);
        background: rgba(22,163,74,0.08);
      }

      .btnRow { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .btnRow button { flex: 1 1 120px; }

      @media (max-width: 420px) {
        .grid2 { grid-template-columns: 1fr; }
        .detailTop { flex-direction: column; align-items: stretch; }
        .detailActions { justify-content: flex-start; }
      }
    </style>
  </head>
  <body>
    <div class="topLoader" aria-hidden="true"><div class="topLoaderBar" id="topLoaderBar"></div></div>
    <div class="wrap">
      <h1>Odoo O2Sheets <span class="pill" id="uiBuild"></span></h1>
      <div class="hint" id="ctx"></div>
      <details style="margin:6px 0 0;">
        <summary class="meta" style="cursor:pointer;">Info tecnica</summary>
        <div class="meta" id="ctxTech" style="margin-top:6px;"></div>
      </details>
      <div class="status" id="statusBar">
        <div class="row">
          <div class="title" id="statusText"></div>
          <button id="btnClearStatus" type="button">Limpiar</button>
        </div>
        <div class="small" id="statusDetail"></div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" id="tab_extracts" type="button">Extracciones</button>
        <button class="tabBtn" id="tab_connections" type="button">Conexiones</button>
        <button class="tabBtn" id="tab_help" type="button">Ayuda</button>
      </div>

      <div id="view_help" style="display:none;">
        <div class="card">
          <h2>Guia Rapida</h2>
          <div class="hint">
            1) Crea una conexion (URL + Database).<br />
            2) Hace login (password o API key).<br />
            3) Crea una extraccion: elegi tabla y columnas, guarda, y luego <span class="kbd">Refresh</span>.<br />
            4) Activa <span class="kbd">Timer</span> si queres refresco automatico.
          </div>
        </div>
      </div>

      <div id="view_connections" style="display:none;">
      <div class="card">
        <h2>Conexiones</h2>
        <label>Nombre (opcional)</label>
        <input id="c_title" placeholder="Ej: Produccion" />
        <label>Odoo URL (publica)</label>
        <input id="c_url" placeholder="https://xxxxx.odoo.com o https://xxxxx.dev.odoo.com" />
        <label>Database (nombre exacto)</label>
        <input id="c_db" placeholder="ej: unika-sa-motor-haus1-main-25276166" />

        <div class="row" style="margin-top: 8px;">
          <button id="btnTestUrl">Probar URL</button>
          <button class="primary" id="btnCreateConn">Guardar conexion</button>
          <button class="danger" id="btnCancelConnEdit" type="button" style="display:none;">Cancelar</button>
          <button id="btnReload">Recargar</button>
        </div>
        <div id="connMsg"></div>

        <div class="sep"></div>
        <div class="hint">Conexiones guardadas en esta planilla:</div>
        <div class="list" id="connectionsList"></div>
      </div>

      <div class="card">
        <h2>Login</h2>
        <label>Conexion</label>
        <select id="login_conn"></select>
        <label>Usuario Odoo</label>
        <input id="login_user" placeholder="ej: admin o tu-email@empresa.com" />
        <label>Password o API Key</label>
        <input id="login_pass" type="password" placeholder="password o api key" />
        <div class="hint">Podes usar Password o una API Key de Odoo. Se guardan para que funcione el timer.</div>

        <div id="companyBox" style="display:none; margin-top:10px;">
          <label>Company (multiempresa)</label>
          <select id="login_company"></select>
          <div class="hint">Si tu usuario tiene multiples empresas, elegi cual usar para extraer datos.</div>
        </div>
        <div class="row" style="margin-top: 8px;">
          <button class="primary" id="btnLogin">Probar login</button>
        </div>
        <div id="loginMsg"></div>
      </div>
      </div>

      <div id="view_extracts">
      <div class="card">
        <h2>Nueva Extraccion</h2>
        <div class="grid2">
          <div>
            <label>Nombre (opcional)</label>
            <input id="ds_title" placeholder="Ej: Ventas (res.partner)" />

            <label>Hoja destino</label>
            <select id="ds_sheet"></select>
          </div>
          <div>
            <label>Conexion</label>
            <select id="ds_conn"></select>

            <div id="dsCompanyBox" style="display:none; margin-top:10px;">
              <label>Company (opcional)</label>
              <select id="ds_company"></select>
              <div class="hint">Si lo dejas en "Default", usa la company de la conexion (Login).</div>
            </div>
          </div>
        </div>

        <h3>Tabla (modelo)</h3>
        <input id="ds_model" type="hidden" />
        <div class="row" style="margin-top: 8px;">
          <div class="col">
            <div class="title" id="chosenModelTitle">Sin tabla seleccionada</div>
            <div class="meta" id="chosenModelMeta">Usa "Seleccionar tabla" para buscar por nombre.</div>
          </div>
          <button class="primary" id="btnOpenModelPicker">Seleccionar tabla</button>
        </div>

        <h3>Columnas</h3>
        <div class="row wrap" style="margin-top: 8px;">
          <div class="hint col full" id="chosenFieldsHint">0 columnas seleccionadas.</div>
          <button class="primary" id="btnOpenColumnsPicker" disabled>Elegir columnas</button>
          <button id="btnClearDraft" type="button">Limpiar</button>
        </div>
        <div class="pills" id="chosenFieldsPills" style="margin-top: 8px;"></div>

        <div class="sep"></div>
        <div class="grid2">
          <div>
            <label>Limite</label>
            <input id="ds_limit" type="number" value="80" />
          </div>
          <div>
            <label>Orden (opcional)</label>
            <input id="ds_order" placeholder="id desc" />
          </div>
        </div>
        <div class="row" style="margin-top:10px; justify-content:space-between;">
          <div class="meta col"><b>Filtros (opcional)</b></div>
          <button class="primary" id="btnEditFilters" type="button">Editar filtros</button>
        </div>
        <div class="hint" id="ds_filters_summary">Sin filtros.</div>
        <details style="margin-top:8px;">
          <summary class="title" style="cursor:pointer;">Avanzado (JSON)</summary>
          <div class="hint">Si queres OR/AND complejos, edita el JSON aca.</div>
          <textarea id="ds_domain" placeholder='[["active","=",true]]'></textarea>
        </details>
        <div class="grid2">
          <div>
            <label>Modo de escritura</label>
            <select id="ds_mode">
              <option value="REPLACE">REPLACE</option>
              <option value="APPEND">APPEND</option>
            </select>
          </div>
          <div>
            <label><input type="checkbox" id="ds_header" checked /> Escribir encabezados</label>
          </div>
        </div>
        <div class="row" style="margin-top: 8px;">
          <button class="primary" id="btnCreateDs">Guardar extraccion</button>
        </div>
        <div class="row" id="editBar" style="display:none; margin-top: 8px; align-items:center; justify-content:space-between;">
          <div class="hint" id="editLabel"></div>
          <button class="danger" id="btnCancelEdit" type="button">Cancelar edicion</button>
        </div>
        <div id="dsMsg"></div>
      </div>

      <div class="card">
        <h2>Mis Extracciones</h2>
        <div class="list" id="datasourcesList"></div>
        <div id="datasourceDetail" style="display:none;"></div>
      </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const UI_BUILD = "2026-02-10f";

      let state = { context: null, connections: [], datasources: [], draft: null };
      let selectedFields = []; // [{fieldName,label,type}]
      let chosenModel = { model: "", name: "" };
      let editingDatasourceId = "";
      let companyByConn = {}; // connId -> { companies: [{id,name}], companyId }
      let dsCompanies = []; // companies for extraction editor dropdown
      let editingConnId = "";
      let currentView = "extracts"; // extracts | connections | help
      let currentDatasourceId = "";
      let openMenuForDatasourceId = "";
      let sheetNames = [];

      function setStatus(kind, text, detail) {
        const bar = $("statusBar");
        const txt = $("statusText");
        const det = $("statusDetail");
        if (!bar || !txt || !det) return;
        const k = kind === "ok" || kind === "err" || kind === "info" ? kind : "info";
        bar.className = `status show ${k}`;
        txt.textContent = text ? String(text) : "";
        det.textContent = detail ? String(detail) : "";
      }

      function setMsg(el, kind, text) {
        if (!el) {
          if (text) setStatus(kind === "ok" ? "ok" : "err", text);
          return;
        }
        el.innerHTML = "";
        if (!text) return;
        const d = document.createElement("div");
        d.className = "msg " + (kind === "ok" ? "ok" : "err");
        d.textContent = text;
        el.appendChild(d);
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderCompanyBox(connId) {
        const box = $("companyBox");
        const sel = $("login_company");
        if (!box || !sel) return;
        const entry = companyByConn[connId];
        const companies = entry && entry.companies ? entry.companies : [];
        if (!companies || companies.length <= 1) {
          box.style.display = "none";
          return;
        }
        box.style.display = "block";
        sel.innerHTML = "";
        companies.forEach((c) => {
          const o = document.createElement("option");
          o.value = String(c.id);
          o.textContent = `${c.name} (#${c.id})`;
          sel.appendChild(o);
        });
        const current = entry.companyId ? String(entry.companyId) : "";
        if (current) sel.value = current;
      }

      function renderDsCompanyBox(connId, selectedCompanyId) {
        const box = $("dsCompanyBox");
        const sel = $("ds_company");
        if (!box || !sel) return;
        const entry = companyByConn[connId];
        const companies = entry && entry.companies ? entry.companies : [];
        dsCompanies = companies || [];
        if (!companies || companies.length <= 1) {
          box.style.display = "none";
          sel.innerHTML = "";
          return;
        }
        box.style.display = "block";
        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Default (de la conexion)";
        sel.appendChild(opt0);
        companies.forEach((c) => {
          const o = document.createElement("option");
          o.value = String(c.id);
          o.textContent = `${c.name} (#${c.id})`;
          sel.appendChild(o);
        });
        if (selectedCompanyId) sel.value = String(selectedCompanyId);
        else sel.value = "";
      }

      function runServer(fnName, args, onOk, onErr, opts) {
        const timeoutMs = (opts && opts.timeoutMs) || 45000;
        const g = window.google;
        if (!(g && g.script && g.script.run)) {
          setStatus(
            "err",
            "No se encontro google.script.run (esto suele pasar si el sidebar no se abrio desde Google Sheets)."
          );
          return;
        }

        if (!window.__o2_loadingCount) window.__o2_loadingCount = 0;
        window.__o2_loadingCount += 1;
        document.body.classList.add("loading");

        let done = false;
        const t = setTimeout(() => {
          if (done) return;
          try {
            window.__o2_loadingCount = Math.max(0, (window.__o2_loadingCount || 1) - 1);
            if (!window.__o2_loadingCount) document.body.classList.remove("loading");
          } catch (_) {}
          setStatus("err", "Timeout esperando respuesta del servidor.", `Funcion: ${fnName}`);
        }, timeoutMs);

        const success = (res) => {
          done = true;
          clearTimeout(t);
          try {
            window.__o2_loadingCount = Math.max(0, (window.__o2_loadingCount || 1) - 1);
            if (!window.__o2_loadingCount) document.body.classList.remove("loading");
          } catch (_) {}
          if (onOk) onOk(res);
        };
        const failure = (e) => {
          done = true;
          clearTimeout(t);
          try {
            window.__o2_loadingCount = Math.max(0, (window.__o2_loadingCount || 1) - 1);
            if (!window.__o2_loadingCount) document.body.classList.remove("loading");
          } catch (_) {}
          const msg = (e && (e.message || (e.toString && e.toString()))) || String(e || "Error");
          if (onErr) onErr(e);
          else setStatus("err", msg);
        };

        try {
          const runner = g.script.run.withSuccessHandler(success).withFailureHandler(failure);
          const arr = Array.isArray(args) ? args : args === undefined ? [] : [args];
          const fn = runner && runner[fnName];
          if (typeof fn !== "function") {
            clearTimeout(t);
            try {
              window.__o2_loadingCount = Math.max(0, (window.__o2_loadingCount || 1) - 1);
              if (!window.__o2_loadingCount) document.body.classList.remove("loading");
            } catch (_) {}
            setStatus(
              "err",
              "Error ejecutando llamada al servidor.",
              `La funcion "${fnName}" no existe. Probable version vieja del add-on. Recarga la planilla (F5), cierra y vuelve a abrir el sidebar. UI=${UI_BUILD}.`
            );
            return;
          }
          fn.apply(runner, arr);
        } catch (e) {
          clearTimeout(t);
          try {
            window.__o2_loadingCount = Math.max(0, (window.__o2_loadingCount || 1) - 1);
            if (!window.__o2_loadingCount) document.body.classList.remove("loading");
          } catch (_) {}
          setStatus("err", "Error ejecutando llamada al servidor.", e && (e.message || String(e)));
        }
      }

      function loadBootstrap() {
        setStatus("info", "Cargando estado...");
        runServer(
          "api_getBootstrap",
          [],
          (res) => {
            state = res;
            $("ctx").textContent = `Usuario Google: ${res.context.userEmail}`;
            try {
              $("ctxTech").textContent = `Doc ID: ${res.context.spreadsheetId}`;
            } catch (_) {}
            render();
            refreshSheets();
            if (res.draft) applyDraft(res.draft);
            setStatus("ok", "Listo.");
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setMsg($("connMsg"), "err", msg);
            setStatus("err", "No se pudo cargar el estado.", msg);
          }
        );
      }

      function updateChosenModelUI() {
        const model = ($("ds_model").value || "").trim();
        const title = $("chosenModelTitle");
        const meta = $("chosenModelMeta");
        if (!model) {
          title.textContent = "Sin tabla seleccionada";
          meta.textContent = 'Usa "Seleccionar tabla" para buscar por nombre.';
          $("btnOpenColumnsPicker").disabled = true;
          return;
        }
        title.textContent = chosenModel.name ? chosenModel.name : model;
        meta.textContent = `Modelo: ${model}`;
        $("btnOpenColumnsPicker").disabled = false;
      }

      function updateChosenFieldsUI() {
        const hint = $("chosenFieldsHint");
        const pills = $("chosenFieldsPills");
        const n = selectedFields.length;
        hint.textContent = `${n} columna${n === 1 ? "" : "s"} seleccionada${n === 1 ? "" : "s"}.`;
        pills.innerHTML = "";
        selectedFields.slice(0, 10).forEach((f) => {
          const p = document.createElement("span");
          p.className = "pill";
          p.textContent = f.fieldName;
          pills.appendChild(p);
        });
        if (n > 10) {
          const p = document.createElement("span");
          p.className = "pill";
          p.textContent = `+${n - 10} mas`;
          pills.appendChild(p);
        }
      }

      function setEditingUI(ds) {
        const bar = $("editBar");
        const label = $("editLabel");
        const btn = $("btnCreateDs");
        if (!bar || !label || !btn) return;
        if (!ds) {
          editingDatasourceId = "";
          bar.style.display = "none";
          btn.textContent = "Guardar extraccion";
          return;
        }
        editingDatasourceId = ds.id;
        bar.style.display = "flex";
        label.textContent = `Editando: ${ds.sheetName} | ${ds.odooModel}`;
        btn.textContent = "Guardar cambios";
      }

      function setConnEditingUI(conn) {
        const btn = $("btnCreateConn");
        const cancel = $("btnCancelConnEdit");
        if (!btn || !cancel) return;
        if (!conn) {
          editingConnId = "";
          btn.textContent = "Guardar conexion";
          cancel.style.display = "none";
          try { $("c_title").value = ""; } catch (_) {}
          try { $("c_url").value = ""; } catch (_) {}
          try { $("c_db").value = ""; } catch (_) {}
          return;
        }
        editingConnId = conn.id;
        btn.textContent = "Guardar cambios";
        cancel.style.display = "inline-block";
        try { $("c_title").value = conn.title || ""; } catch (_) {}
        try { $("c_url").value = conn.odooUrl || ""; } catch (_) {}
        try { $("c_db").value = conn.odooDb || ""; } catch (_) {}
      }

      function setView(view) {
        currentView = view;
        const vExtracts = $("view_extracts");
        const vConns = $("view_connections");
        const vHelp = $("view_help");
        if (vExtracts) vExtracts.style.display = view === "extracts" ? "block" : "none";
        if (vConns) vConns.style.display = view === "connections" ? "block" : "none";
        if (vHelp) vHelp.style.display = view === "help" ? "block" : "none";

        const b1 = $("tab_extracts");
        const b2 = $("tab_connections");
        const b3 = $("tab_help");
        if (b1) b1.classList.toggle("active", view === "extracts");
        if (b2) b2.classList.toggle("active", view === "connections");
        if (b3) b3.classList.toggle("active", view === "help");
      }

      function setDatasourceDetail(id) {
        currentDatasourceId = id || "";
        openMenuForDatasourceId = "";
        render();
      }

      function safeCopyToClipboard(text) {
        const t = String(text || "");
        if (!t) return false;
        try {
          if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(t);
            return true;
          }
        } catch (_) {}
        try {
          const ta = document.createElement("textarea");
          ta.value = t;
          ta.style.position = "fixed";
          ta.style.left = "-1000px";
          ta.style.top = "-1000px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        } catch (_) {
          return false;
        }
      }

      function fmtIsoShort(iso) {
        const s = String(iso || "").trim();
        if (!s) return "";
        try {
          const d = new Date(s);
          if (String(d) === "Invalid Date") return s;
          const pad = (n) => String(n).padStart(2, "0");
          const yyyy = d.getFullYear();
          const mm = pad(d.getMonth() + 1);
          const dd = pad(d.getDate());
          const hh = pad(d.getHours());
          const mi = pad(d.getMinutes());
          return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
        } catch {
          return s;
        }
      }

      function render() {
        // Connections list
        const cl = $("connectionsList");
        cl.innerHTML = "";
        if (!state.connections.length) {
          const d = document.createElement("div");
          d.className = "hint";
          d.textContent = "No hay conexiones todavia.";
          cl.appendChild(d);
        } else {
          state.connections.forEach((c) => {
            const it = document.createElement("div");
            it.className = "item";
            const credText = c.hasCredential ? "OK" : "Falta login";
            it.innerHTML = `
              <div class="title">${escapeHtml(c.title || c.name)}</div>
              <div class="meta">${escapeHtml(c.odooUrl)} | DB: ${escapeHtml(c.odooDb)}</div>
              <div class="meta">Login: ${escapeHtml(credText)}${c.savedUsername ? " | " + escapeHtml(c.savedUsername) : ""}${c.companyId ? " | Company: #" + escapeHtml(c.companyId) : ""}</div>
              <div class="btnRow" style="margin-top:8px;">
                <button class="primary" data-action="conn_new_ds" data-id="${c.id}" type="button">Nueva extraccion</button>
                <button data-action="conn_use" data-id="${c.id}" type="button">Seleccionar</button>
                <button data-action="conn_edit" data-id="${c.id}">Editar</button>
                <button data-action="conn_logout" data-id="${c.id}">Logout</button>
                <button class="danger" data-action="conn_delete" data-id="${c.id}">Borrar</button>
              </div>
            `;
            cl.appendChild(it);
          });
        }

        // Connection selects
        const prevLogin = $("login_conn").value;
        const prevDs = $("ds_conn").value;
        for (const sid of ["login_conn", "ds_conn"]) {
          const sel = $(sid);
          sel.innerHTML = "";
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = "Seleccionar...";
          sel.appendChild(opt0);
          state.connections.forEach((c) => {
            const o = document.createElement("option");
            o.value = c.id;
            o.textContent = c.title || c.name;
            sel.appendChild(o);
          });
        }
        if (prevLogin) $("login_conn").value = prevLogin;
        if (prevDs) $("ds_conn").value = prevDs;
        if (!prevLogin && state.connections.length === 1) $("login_conn").value = state.connections[0].id;
        if (!prevDs && state.connections.length === 1) $("ds_conn").value = state.connections[0].id;

        // Prefill username from saved credential (if any).
        try {
          const connId = $("login_conn").value;
          const c = (state.connections || []).find((x) => x.id === connId);
          if (c && c.savedUsername && !String($("login_user").value || "").trim()) {
            $("login_user").value = c.savedUsername;
          }
        } catch (_) {}

        // Datasources list + detail
        const dl = $("datasourcesList");
        const detail = $("datasourceDetail");
        if (dl) dl.innerHTML = "";
        if (detail) detail.innerHTML = "";

        const dsCurrent = currentDatasourceId
          ? (state.datasources || []).find((x) => x.id === currentDatasourceId)
          : null;

        if (dsCurrent && detail) {
          if (dl) dl.style.display = "none";
          detail.style.display = "block";

          const title = dsCurrent.title ? dsCurrent.title : dsCurrent.sheetName;
          const company = dsCurrent.companyId ? `Company: #${dsCurrent.companyId}` : "";
          const conn = (state.connections || []).find((c) => c.id === dsCurrent.connectionId);
          const connTitle = conn ? conn.title || conn.name : dsCurrent.connectionId;
          const last = dsCurrent.lastRun
            ? `${dsCurrent.lastRun.status} @ ${fmtIsoShort(dsCurrent.lastRun.at)} (${dsCurrent.lastRun.rows} filas)`
            : "nunca";
          const ok = dsCurrent.lastRun && dsCurrent.lastRun.status === "OK";
          const statusPill = dsCurrent.lastRun
            ? `<span class="pill statusPill ${ok ? "ok" : "err"}">${escapeHtml(dsCurrent.lastRun.status)}</span>`
            : `<span class="pill">NEW</span>`;

          const auto = dsCurrent.schedulerEnabled ? "AUTO: ON" : "AUTO: OFF";
          const autoMeta = dsCurrent.schedulerEnabled
            ? `Timezone: ${(dsCurrent.schedulerConfig && dsCurrent.schedulerConfig.timezone) || "?"} | Horas: ${((dsCurrent.schedulerConfig && dsCurrent.schedulerConfig.hours) || []).join(",") || "todas"}`
            : "Auto refresh desactivado.";
          const nextRun = dsCurrent.nextRunAt ? `Proxima: ${dsCurrent.nextRunAt}` : "";
          const fieldsFromDraft =
            editingDatasourceId === dsCurrent.id && selectedFields && selectedFields.length ? selectedFields : null;
          const fields = (fieldsFromDraft || dsCurrent.fields || []).slice().sort((a, b) => (a.order || 0) - (b.order || 0));
          const curModel = ($("ds_model").value || "").trim() || dsCurrent.odooModel;
          const curModelName = chosenModel && chosenModel.name ? chosenModel.name : curModel;
          const errText = dsCurrent.lastRun && dsCurrent.lastRun.status === "ERROR" ? (dsCurrent.lastRun.error || "") : "";

          detail.innerHTML = `
            <div class="card">
              <div class="detailTop">
                <div>
                  <div class="detailTitle">${escapeHtml(title)} <span class="pill">${escapeHtml(dsCurrent.odooModel)}</span> ${statusPill}</div>
                  <div class="meta">Conexion: ${escapeHtml(connTitle)} | Hoja: ${escapeHtml(dsCurrent.sheetName)} ${company ? "| " + escapeHtml(company) : ""}</div>
                  <div class="meta">${escapeHtml(auto)} | ${escapeHtml(autoMeta)}</div>
                  ${nextRun ? `<div class="meta">${escapeHtml(nextRun)}</div>` : ""}
                  <div class="meta">Ultima: ${escapeHtml(last)}</div>
                </div>
                <div class="detailActions">
                  <button data-action="back_ds" type="button">Volver</button>
                  <button class="primary" data-action="refresh" data-id="${dsCurrent.id}" type="button">Refresh</button>
                  <div class="menuWrap">
                    <button class="menuBtn" data-action="menu_ds" data-id="${dsCurrent.id}" type="button" aria-label="Menu">...</button>
                    ${
                      openMenuForDatasourceId === dsCurrent.id
                        ? `<div class="menu">
                            <button class="menuItem" data-action="edit" data-id="${dsCurrent.id}" type="button">Editar</button>
                            <button class="menuItem" data-action="schedule" data-id="${dsCurrent.id}" type="button">Timer</button>
                            <button class="menuItem" data-action="history" data-id="${dsCurrent.id}" type="button">Historial</button>
                            <button class="menuItem" data-action="duplicate" data-id="${dsCurrent.id}" type="button">Duplicar</button>
                            <button class="menuItem" data-action="rename" data-id="${dsCurrent.id}" type="button">Renombrar</button>
                            <button class="menuItem danger" data-action="delete" data-id="${dsCurrent.id}" type="button">Borrar</button>
                          </div>`
                        : ""
                    }
                  </div>
                </div>
              </div>
              ${
                errText
                  ? `<div class="msg err" style="margin-top:10px;">
                      <div class="row" style="justify-content:space-between;">
                        <div><b>Ultimo error</b></div>
                        <button class="smallBtn" data-action="copy_error" data-id="${dsCurrent.id}" type="button">Copiar</button>
                      </div>
                      <div class="meta" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(errText)}</div>
                    </div>`
                  : ""
              }
              <div class="sep"></div>
              <div class="meta"><b>Tabla</b></div>
              <div class="row" style="margin-top:8px;">
                <div class="col">
                  <div class="title">${escapeHtml(curModelName)}</div>
                  <div class="meta">Modelo: ${escapeHtml(curModel)}</div>
                </div>
                <button class="primary" data-action="pick_model_detail" data-id="${dsCurrent.id}" type="button">Cambiar tabla</button>
              </div>

              <div class="sep"></div>
              <div class="row">
                <div class="meta col"><b>Columnas</b></div>
                <button class="primary" data-action="pick_columns_detail" data-id="${dsCurrent.id}" type="button">Editar columnas</button>
              </div>
              <div class="pills" style="margin-top:8px;">
                ${fields.map((f) => `<span class="pill">${escapeHtml(f.fieldName)}</span>`).join("")}
              </div>

              <div class="sep"></div>
              <details>
                <summary class="title" style="cursor:pointer;">Opciones</summary>
                <div style="margin-top:10px;">
                  <div class="grid2">
                    <div>
                      <label>Nombre</label>
                      <input id="d_title" value="${escapeHtml(dsCurrent.title || "")}" placeholder="(opcional)" />
                    </div>
                    <div>
                      <label>Hoja destino</label>
                      <select id="d_sheet"></select>
                    </div>
                  </div>
                  <div class="grid2" style="margin-top:8px;">
                    <div>
                      <label>Conexion</label>
                      <select id="d_conn"></select>
                    </div>
                    <div>
                      <label>Company (opcional)</label>
                      <select id="d_company"></select>
                      <div class="hint">Default = usa la company de la conexion (Login).</div>
                    </div>
                  </div>

                   <div class="grid2" style="margin-top:8px;">
                     <div>
                       <label>Limite</label>
                       <input id="d_limit" type="number" value="${escapeHtml(dsCurrent.limit || 80)}" />
                     </div>
                     <div>
                       <label>Orden</label>
                       <input id="d_order" value="${escapeHtml(dsCurrent.orderBy || "")}" placeholder="id desc" />
                     </div>
                   </div>
                  <div class="row" style="margin-top:10px; justify-content:space-between;">
                    <div class="meta col"><b>Filtros</b></div>
                    <button class="primary" data-action="pick_filters_detail" data-id="${dsCurrent.id}" type="button">Editar filtros</button>
                  </div>
                  <div class="hint" id="d_filters_summary">Sin filtros.</div>
                  <details style="margin-top:8px;">
                    <summary class="title" style="cursor:pointer;">Avanzado (JSON)</summary>
                    <textarea id="d_domain" style="min-height:72px;">${escapeHtml(dsCurrent.domain || "")}</textarea>
                  </details>
                  <div class="grid2" style="margin-top:8px;">
                    <div>
                      <label>Modo de escritura</label>
                      <select id="d_mode">
                        <option value="REPLACE">REPLACE</option>
                        <option value="APPEND">APPEND</option>
                      </select>
                    </div>
                    <div>
                      <label><input type="checkbox" id="d_header" ${dsCurrent.header ? "checked" : ""}/> Escribir encabezados</label>
                    </div>
                  </div>
                  <div class="row" style="margin-top:10px; justify-content:flex-end;">
                    <button class="primary" data-action="save_detail" data-id="${dsCurrent.id}" type="button">Guardar cambios</button>
                  </div>
                </div>
              </details>
              <div id="ds_item_msg_${dsCurrent.id}"></div>
            </div>
          `;

          // Populate selects in detail after HTML is inserted.
          try {
            const dSheet = $("d_sheet");
            if (dSheet) {
              dSheet.innerHTML = "";
              (sheetNames || []).forEach((n) => {
                const o = document.createElement("option");
                o.value = n;
                o.textContent = n;
                dSheet.appendChild(o);
              });
              dSheet.value = dsCurrent.sheetName;
            }
          } catch (_) {}
          try {
            const dConn = $("d_conn");
            if (dConn) {
              dConn.innerHTML = "";
              (state.connections || []).forEach((c) => {
                const o = document.createElement("option");
                o.value = c.id;
                o.textContent = c.title || c.name;
                dConn.appendChild(o);
              });
              dConn.value = dsCurrent.connectionId;
            }
          } catch (_) {}
          try {
            const dMode = $("d_mode");
            if (dMode) dMode.value = dsCurrent.writeMode || "REPLACE";
          } catch (_) {}
          try {
            const dCompany = $("d_company");
            if (dCompany) {
              dCompany.innerHTML = "";
              const opt0 = document.createElement("option");
              opt0.value = "";
              opt0.textContent = "Default (de la conexion)";
              dCompany.appendChild(opt0);
              const connId = dsCurrent.connectionId;
              const entry = companyByConn[connId];
              const companies = entry && entry.companies ? entry.companies : [];
              (companies || []).forEach((c) => {
                const o = document.createElement("option");
                o.value = String(c.id);
                o.textContent = `${c.name} (#${c.id})`;
                dCompany.appendChild(o);
              });
              dCompany.value = dsCurrent.companyId ? String(dsCurrent.companyId) : "";
            }
          } catch (_) {}
          try {
            const dDom = $("d_domain");
            if (dDom) dDom.addEventListener("input", updateFilterSummaries);
          } catch (_) {}
          updateFilterSummaries();
        } else {
          currentDatasourceId = "";
          openMenuForDatasourceId = "";
          if (dl) dl.style.display = "block";
          if (detail) detail.style.display = "none";

          if (!state.datasources.length) {
            const d = document.createElement("div");
            d.className = "hint";
            d.textContent = "No hay extracciones todavia.";
            if (dl) dl.appendChild(d);
          } else {
            state.datasources.forEach((ds) => {
              const it = document.createElement("div");
              it.className = "item";
              it.setAttribute("data-open-ds", ds.id);

              const title = ds.title ? ds.title : ds.sheetName;
              const ok = ds.lastRun && ds.lastRun.status === "OK";
              const statusPill = ds.lastRun
                ? `<span class="pill statusPill ${ok ? "ok" : "err"}">${escapeHtml(ds.lastRun.status)}</span>`
                : `<span class="pill">NEW</span>`;
              const nextRun = ds.nextRunAt ? `Prox: ${ds.nextRunAt}` : "";
              const fields = (ds.fields || []).map((f) => f.fieldName);
              const fieldsPreview = fields.slice(0, 3).join(", ") + (fields.length > 3 ? ` (+${fields.length - 3})` : "");

              it.innerHTML = `
                <div class="dsRow" data-open-ds="${ds.id}">
                  <div class="dsRowIcon">O2</div>
                  <div>
                    <div class="title">${escapeHtml(title)} <span class="pill">${escapeHtml(ds.odooModel)}</span> ${statusPill}</div>
                    <div class="meta">Columnas: ${escapeHtml(fieldsPreview || "")}</div>
                    ${nextRun ? `<div class="meta">${escapeHtml(nextRun)}</div>` : ""}
                  </div>
                  <div class="menuWrap">
                    <button class="iconBtn primary" title="Refresh" aria-label="Refresh" data-action="refresh" data-id="${ds.id}" type="button">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v7h-7"/></svg>
                    </button>
                    <button class="menuBtn" data-action="menu_ds" data-id="${ds.id}" type="button" aria-label="Menu">...</button>
                    ${
                      openMenuForDatasourceId === ds.id
                        ? `<div class="menu">
                            <button class="menuItem" data-action="open_ds" data-id="${ds.id}" type="button">Abrir detalle</button>
                            <button class="menuItem" data-action="edit" data-id="${ds.id}" type="button">Editar</button>
                            <button class="menuItem" data-action="schedule" data-id="${ds.id}" type="button">Timer</button>
                            <button class="menuItem" data-action="history" data-id="${ds.id}" type="button">Historial</button>
                            <button class="menuItem" data-action="duplicate" data-id="${ds.id}" type="button">Duplicar</button>
                            <button class="menuItem" data-action="rename" data-id="${ds.id}" type="button">Renombrar</button>
                            <button class="menuItem danger" data-action="delete" data-id="${ds.id}" type="button">Borrar</button>
                          </div>`
                        : ""
                    }
                  </div>
                </div>
                <div id="ds_item_msg_${ds.id}"></div>
              `;
              if (dl) dl.appendChild(it);
            });
          }
        }

        updateChosenModelUI();
        updateChosenFieldsUI();
      }

      function tryLoadCompaniesForConnection(connId) {
        if (!connId) return;
        runServer(
          "api_getCompanies",
          [{ connectionId: connId }],
          (res) => {
            companyByConn[connId] = { companies: res.companies || [], companyId: res.companyId };
            renderCompanyBox(connId);
            renderDsCompanyBox(connId);
          },
          () => {
            // Ignore if not logged in yet.
            try {
              const box = $("companyBox");
              if (box) box.style.display = "none";
              const b2 = $("dsCompanyBox");
              if (b2) b2.style.display = "none";
            } catch (_) {}
          }
        );
      }

      function refreshSheets() {
        runServer(
          "api_listSheets",
          [],
          (names) => {
            sheetNames = names || [];
            const sel = $("ds_sheet");
            sel.innerHTML = "";
            sheetNames.forEach((n) => {
              const o = document.createElement("option");
              o.value = n;
              o.textContent = n;
              sel.appendChild(o);
            });
          },
          (e) => setMsg($("dsMsg"), "err", (e && (e.message || String(e))) || "Error")
        );
      }

      function suggestDbFromUrl() {
        const url = ($("c_url").value || "").trim();
        if (!url) return;
        try {
          const u = new URL(url.replace(/\/+$/, ""));
          const host = u.hostname || "";
          if (host.endsWith(".odoo.com")) {
            const sub = host.split(".")[0];
            if (sub && !$("c_db").value.trim()) $("c_db").value = sub;
          }
        } catch (_) {}
      }

      $("c_url").addEventListener("blur", suggestDbFromUrl);

      $("btnReload").addEventListener("click", loadBootstrap);
      let draftUpdatedAt = "";

      function describeDomain(domainStr) {
        const raw = String(domainStr || "").trim();
        if (!raw) return "Sin filtros.";
        try {
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return "Filtro avanzado (JSON).";
          const isTerm = (x) => Array.isArray(x) && x.length === 3 && typeof x[0] === "string" && typeof x[1] === "string";
          const onlyTerms = parsed.length === 0 || parsed.every((x) => isTerm(x));
          const onlyOrTokensAndTerms =
            parsed.length >= 3 &&
            parsed.every((x) => (typeof x === "string" ? x === "|" : isTerm(x))) &&
            parsed.filter((x) => typeof x === "string").length === parsed.filter((x) => typeof x !== "string").length - 1;

          if (onlyTerms) return parsed.length ? `${parsed.length} regla(s) (AND).` : "Sin filtros.";
          if (onlyOrTokensAndTerms) {
            const terms = parsed.filter((x) => typeof x !== "string");
            return terms.length ? `${terms.length} regla(s) (OR).` : "Sin filtros.";
          }
          if (parsed.some((x) => x === "&" || x === "|")) return "Filtro con grupos (visual).";
          return "Filtro avanzado (JSON).";
        } catch {
          return "JSON invalido (corregir en Avanzado).";
        }
      }

      function updateFilterSummaries() {
        try {
          const el = $("ds_filters_summary");
          if (el) el.textContent = describeDomain($("ds_domain") ? $("ds_domain").value : "");
        } catch (_) {}
        try {
          const el = $("d_filters_summary");
          if (el) el.textContent = describeDomain($("d_domain") ? $("d_domain").value : "");
        } catch (_) {}
      }

      $("login_conn").addEventListener("change", () => {
        const connId = $("login_conn").value;
        try {
          const c = (state.connections || []).find((x) => x.id === connId);
          if (c && c.savedUsername) $("login_user").value = c.savedUsername;
        } catch (_) {}
        tryLoadCompaniesForConnection(connId);
      });

      $("ds_conn").addEventListener("change", () => {
        const connId = $("ds_conn").value;
        if (!connId) return;
        tryLoadCompaniesForConnection(connId);
        // Keep the extraction-level selector in sync (if companies are available).
        renderDsCompanyBox(connId);
      });

      $("login_company").addEventListener("change", () => {
        const connId = $("login_conn").value;
        const companyId = $("login_company").value;
        if (!connId) return;
        setStatus("info", "Guardando company...", `Company: ${companyId}`);
        runServer(
          "api_setConnectionCompany",
          [{ connectionId: connId, companyId: companyId ? Number(companyId) : undefined }],
          () => {
            if (companyByConn[connId]) companyByConn[connId].companyId = companyId ? Number(companyId) : undefined;
            setStatus("ok", "Company guardada.");
            loadBootstrap();
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No pude guardar la company.", msg);
          }
        );
      });

      function applyDraft(draft) {
        if (!draft) return;
        draftUpdatedAt = draft.updatedAt || draftUpdatedAt;

        if (draft.connectionId) {
          try {
            $("ds_conn").value = draft.connectionId;
          } catch (_) {}
        }

        const model = (draft.model || "").trim();
        if (model) {
          $("ds_model").value = model;
          chosenModel = { model, name: (draft.modelName || "").trim() || model };
        }

        selectedFields = (draft.fields || [])
          .slice()
          .sort((a, b) => (a.order || 0) - (b.order || 0))
          .map((f) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, type: f.type || "" }));

        if (typeof draft.domain === "string") {
          try {
            if ($("ds_domain")) $("ds_domain").value = draft.domain || "";
          } catch (_) {}
          try {
            if ($("d_domain")) $("d_domain").value = draft.domain || "";
          } catch (_) {}
        }

        updateChosenModelUI();
        updateChosenFieldsUI();
        updateFilterSummaries();
      }

      function pollDraftChange(prevUpdatedAt, onChanged) {
        const started = Date.now();
        const tick = () => {
          runServer(
            "api_getDraftExtraction",
            [],
            (draft) => {
              const cur = (draft && draft.updatedAt) || "";
              if (cur && cur !== prevUpdatedAt) {
                applyDraft(draft);
                if (onChanged) onChanged(draft);
                return;
              }
              if (Date.now() - started > 60 * 1000) {
                setStatus("info", "No se detectaron cambios (si elegiste algo, toca Recargar).");
                return;
              }
              setTimeout(tick, 700);
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude leer el draft.", msg);
            }
          );
        };
        tick();
      }

      $("btnOpenModelPicker").addEventListener("click", () => {
        const connId = $("ds_conn").value || $("login_conn").value;
        if (!connId) return setStatus("err", "Primero selecciona una conexion y hace login.");
        const prev = draftUpdatedAt;
        const companyId = $("ds_company") ? Number($("ds_company").value || "") || undefined : undefined;
        setStatus("info", "Abriendo selector de tabla...");
        runServer(
          "ui_openModelPickerDialog",
          [connId, companyId],
          () => {
            pollDraftChange(prev, () => {
              // After picking a table, open columns picker automatically (most intuitive flow).
              const model = ($("ds_model").value || "").trim();
              if (!model) return;
              if (selectedFields.length) return setStatus("ok", "Tabla seleccionada.");
              setStatus("info", "Tabla seleccionada. Abriendo selector de columnas...");
              const prevCols = draftUpdatedAt;
              setTimeout(() => {
                runServer(
                  "ui_openColumnsPickerDialog",
                  [connId, model, companyId],
                  () => pollDraftChange(prevCols, () => setStatus("ok", "Columnas actualizadas.")),
                  (e) => {
                    const msg = (e && (e.message || String(e))) || "Error";
                    setStatus("err", "No pude abrir el selector de columnas.", msg);
                  }
                );
              }, 250);
            });
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No pude abrir el selector.", msg);
          }
        );
      });

      $("btnOpenColumnsPicker").addEventListener("click", () => {
        const connId = $("ds_conn").value || $("login_conn").value;
        if (!connId) return setStatus("err", "Primero selecciona una conexion y hace login.");
        const model = ($("ds_model").value || "").trim();
        if (!model) return setStatus("err", "Primero selecciona una tabla.");
        const prev = draftUpdatedAt;
        const companyId = $("ds_company") ? Number($("ds_company").value || "") || undefined : undefined;
        setStatus("info", "Abriendo selector de columnas...");
        runServer(
          "ui_openColumnsPickerDialog",
          [connId, model, companyId],
          () => {
            pollDraftChange(prev, () => setStatus("ok", "Columnas actualizadas."));
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No pude abrir el selector.", msg);
          }
        );
      });

      $("btnEditFilters").addEventListener("click", () => {
        const connId = $("ds_conn").value || $("login_conn").value;
        if (!connId) return setStatus("err", "Primero selecciona una conexion y hace login.");
        const model = ($("ds_model").value || "").trim();
        if (!model) return setStatus("err", "Primero selecciona una tabla.");
        const prev = draftUpdatedAt;
        const companyId = $("ds_company") ? Number($("ds_company").value || "") || undefined : undefined;
        const curDomain = $("ds_domain") ? $("ds_domain").value : "";
        setStatus("info", "Abriendo editor de filtros...");
        runServer(
          "ui_openFilterBuilderDialog",
          [connId, model, curDomain, companyId],
          () => {
            pollDraftChange(prev, () => {
              setStatus("ok", "Filtros actualizados.");
              updateFilterSummaries();
            });
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No pude abrir el editor de filtros.", msg);
          }
        );
      });

      $("ds_domain").addEventListener("input", updateFilterSummaries);

      $("btnClearDraft").addEventListener("click", () => {
        setStatus("info", "Limpiando seleccion...");
        runServer(
          "api_clearDraftExtraction",
          [],
           () => {
             draftUpdatedAt = "";
             try { $("ds_title").value = ""; } catch (_) {}
             $("ds_model").value = "";
             chosenModel = { model: "", name: "" };
             selectedFields = [];
             try { $("ds_domain").value = ""; } catch (_) {}
             updateChosenModelUI();
             updateChosenFieldsUI();
             updateFilterSummaries();
             setEditingUI(null);
             setStatus("ok", "Seleccion limpiada.");
           },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No se pudo limpiar.", msg);
          }
        );
      });

      $("btnCancelEdit").addEventListener("click", () => {
        setEditingUI(null);
        setMsg($("dsMsg"), "ok", "Edicion cancelada.");
      });

      $("btnTestUrl").addEventListener("click", () => {
        setMsg($("connMsg"), "", "");
        const url = ($("c_url").value || "").trim();
        if (!url) return setMsg($("connMsg"), "err", "Pega la URL primero.");
        $("btnTestUrl").disabled = true;
        setStatus("info", "Probando URL...", url);
        runServer(
          "api_testOdooUrl",
          [{ odooUrl: url }],
          () => {
            setMsg($("connMsg"), "ok", "URL OK (es accesible).");
            setStatus("ok", "URL OK.");
            $("btnTestUrl").disabled = false;
          },
          (e) => {
            setMsg($("connMsg"), "err", (e && (e.message || String(e))) || "Error");
            setStatus("err", "Fallo al probar URL.", e && (e.message || String(e)));
            $("btnTestUrl").disabled = false;
          }
        );
      });

      $("btnCreateConn").addEventListener("click", () => {
        setMsg($("connMsg"), "", "");
        const title = ($("c_title").value || "").trim();
        const url = ($("c_url").value || "").trim();
        const db = ($("c_db").value || "").trim();
        if (!url) return setMsg($("connMsg"), "err", "Falta la URL.");
        if (!db) return setMsg($("connMsg"), "err", "Falta el Database.");
        $("btnCreateConn").disabled = true;
        const isEdit = Boolean(editingConnId);
        setStatus("info", isEdit ? "Guardando cambios..." : "Guardando conexion...", `${url} | DB: ${db}`);
        runServer(
          isEdit ? "api_updateConnection" : "api_createConnection",
          [
            isEdit
              ? { id: editingConnId, title: title || "Odoo", odooUrl: url, odooDb: db, storeConnections: false, shareCredentials: false }
              : { title: title || undefined, odooUrl: url, odooDb: db, storeConnections: false, shareCredentials: false },
          ],
          (conn) => {
            setMsg($("connMsg"), "ok", isEdit ? "Cambios guardados." : "Conexion guardada. Ahora hace login.");
            setStatus("ok", isEdit ? "Conexion actualizada." : "Conexion guardada.");
            setConnEditingUI(null);
            loadBootstrap();
            setTimeout(() => {
              try {
                $("login_conn").value = conn.id;
                $("ds_conn").value = conn.id;
              } catch (_) {}
            }, 200);
            $("btnCreateConn").disabled = false;
          },
          (e) => {
            setMsg($("connMsg"), "err", (e && (e.message || String(e))) || "Error");
            setStatus("err", isEdit ? "No se pudieron guardar los cambios." : "No se pudo guardar la conexion.", e && (e.message || String(e)));
            $("btnCreateConn").disabled = false;
          }
        );
      });

      $("btnCancelConnEdit").addEventListener("click", () => setConnEditingUI(null));

      $("btnLogin").addEventListener("click", () => {
        setMsg($("loginMsg"), "", "");
        const connId = $("login_conn").value;
        if (!connId) return setMsg($("loginMsg"), "err", "Selecciona una conexion.");
        $("btnLogin").disabled = true;
        setStatus("info", "Probando login...");
        runServer(
          "api_setCredential",
          [
            {
              connectionId: connId,
              odooUsername: $("login_user").value,
              odooPassword: $("login_pass").value,
            },
          ],
          (res) => {
            setMsg($("loginMsg"), "ok", `Login OK (uid=${res.uid}).`);
            setStatus("ok", "Login OK.");
            $("btnLogin").disabled = false;

            try {
              const companies = (res && res.companies) || [];
              const companyId = res && res.companyId;
              companyByConn[connId] = { companies, companyId };
              renderCompanyBox(connId);
            } catch (_) {}

            loadBootstrap();
          },
          (e) => {
            setMsg($("loginMsg"), "err", (e && (e.message || String(e))) || "Error");
            setStatus("err", "Login fallo.", e && (e.message || String(e)));
            $("btnLogin").disabled = false;
          }
        );
      });

      $("btnCreateDs").addEventListener("click", () => {
        setMsg($("dsMsg"), "", "");
        const connId = $("ds_conn").value;
        const sheet = $("ds_sheet").value;
        const model = ($("ds_model").value || "").trim();
        if (!connId) return setMsg($("dsMsg"), "err", "Selecciona conexion.");
        if (!sheet) return setMsg($("dsMsg"), "err", "Selecciona hoja.");
        if (!model) return setMsg($("dsMsg"), "err", "Selecciona una tabla (modelo).");
        if (!selectedFields.length) return setMsg($("dsMsg"), "err", "Elige al menos 1 columna.");

        const fieldArr = selectedFields.map((f, idx) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, order: idx }));
        $("btnCreateDs").disabled = true;
        const isEdit = Boolean(editingDatasourceId);
        setStatus("info", isEdit ? "Guardando cambios..." : "Guardando extraccion...", `${sheet} | ${model}`);
        runServer(
          isEdit ? "api_updateDatasource" : "api_createDatasource",
          [
            {
              datasourceId: editingDatasourceId,
              title: ($("ds_title").value || "").trim(),
              sheetName: sheet,
              connectionId: connId,
              odooModel: model,
              fields: fieldArr,
              limit: Number($("ds_limit").value || 80),
              domain: $("ds_domain").value,
              orderBy: $("ds_order").value,
              writeMode: $("ds_mode").value,
              header: $("ds_header").checked,
              companyId: $("ds_company") ? Number($("ds_company").value || "") || undefined : undefined,
            },
          ],
          () => {
            setMsg($("dsMsg"), "ok", isEdit ? "Cambios guardados." : "Extraccion guardada. Ahora podes apretar Refresh en la lista de abajo.");
            setStatus("ok", isEdit ? "Cambios guardados." : "Extraccion guardada.");
            $("btnCreateDs").disabled = false;
            setEditingUI(null);
            loadBootstrap();
          },
          (e) => {
            setMsg($("dsMsg"), "err", (e && (e.message || String(e))) || "Error");
            setStatus("err", isEdit ? "No se pudieron guardar los cambios." : "No se pudo guardar la extraccion.", e && (e.message || String(e)));
            $("btnCreateDs").disabled = false;
          }
        );
      });

      document.body.addEventListener("click", (ev) => {
        const btn = ev.target && ev.target.closest && ev.target.closest("button[data-action]");
        const action = btn ? btn.getAttribute("data-action") : null;

        // Click outside: close menus; or open detail when clicking a row.
        if (!action) {
          const openEl = ev.target && ev.target.closest && ev.target.closest("[data-open-ds]");
          if (openEl) {
            const id = openEl.getAttribute("data-open-ds");
            if (id) {
              const ds = (state.datasources || []).find((x) => x.id === id);
               if (ds) {
                 // Prime draft for pickers and for showing pending changes in detail.
                 try {
                   editingDatasourceId = ds.id;
                   $("ds_conn").value = ds.connectionId;
                   $("ds_model").value = ds.odooModel;
                   chosenModel = { model: ds.odooModel, name: ds.odooModel };
                   selectedFields = (ds.fields || []).slice().sort((a,b) => (a.order||0)-(b.order||0)).map((f) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, type: f.type || "" }));
                   updateChosenModelUI();
                   updateChosenFieldsUI();

                    // Sync server-side draft too (so dialogs open with current selection + filters).
                    const connId = ds.connectionId;
                    const model = ds.odooModel;
                    const modelName = model;
                    const fields = (selectedFields || []).map((f, idx) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, order: idx, type: f.type || "" }));
                    runServer(
                      "api_setDraftModel",
                      [{ connectionId: connId, model, modelName }],
                      (draft1) => {
                        applyDraft(draft1);
                        runServer(
                          "api_setDraftFields",
                          [{ connectionId: connId, model, fields }],
                          (draft2) => {
                            applyDraft(draft2);
                            runServer(
                              "api_setDraftDomain",
                              [{ connectionId: connId, model, domain: ds.domain || "" }],
                              (draft3) => applyDraft(draft3),
                              () => {}
                            );
                          },
                          () => {}
                        );
                      },
                      () => {}
                    );
                 } catch (_) {}
               }
               return setDatasourceDetail(id);
             }
           }
          if (openMenuForDatasourceId) {
            openMenuForDatasourceId = "";
            render();
          }
          return;
        }

        if (action === "save_detail") {
          const id = btn.getAttribute("data-id");
          const ds = (state.datasources || []).find((x) => x.id === id);
          if (!id || !ds) return setStatus("err", "No encontre la extraccion.", `Datasource: ${id}`);

          // Use current draft selection as the source of truth for model + fields.
          const model = ($("ds_model").value || "").trim() || ds.odooModel;
          const fieldArr = (selectedFields || []).map((f, idx) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, order: idx }));
          if (!fieldArr.length) return setStatus("err", "Faltan columnas. Usa 'Editar columnas'.");

          const payload = {
            datasourceId: id,
            title: ($("d_title") && $("d_title").value) ? $("d_title").value : "",
            sheetName: ($("d_sheet") && $("d_sheet").value) ? $("d_sheet").value : ds.sheetName,
            connectionId: ($("d_conn") && $("d_conn").value) ? $("d_conn").value : ds.connectionId,
            odooModel: model,
            fields: fieldArr,
            limit: Number(($("d_limit") && $("d_limit").value) || ds.limit || 80),
            domain: ($("d_domain") && $("d_domain").value) ? $("d_domain").value : (ds.domain || ""),
            orderBy: ($("d_order") && $("d_order").value) ? $("d_order").value : (ds.orderBy || ""),
            writeMode: ($("d_mode") && $("d_mode").value) ? $("d_mode").value : (ds.writeMode || "REPLACE"),
            header: Boolean($("d_header") && $("d_header").checked),
            companyId: ($("d_company") && $("d_company").value) ? Number($("d_company").value) : undefined,
          };

          btn.disabled = true;
          setStatus("info", "Guardando cambios...", ds.sheetName);
          runServer(
            "api_updateDatasource",
            [payload],
            () => {
              btn.disabled = false;
              setStatus("ok", "Cambios guardados.");
              loadBootstrap();
            },
            (e) => {
              btn.disabled = false;
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No se pudieron guardar los cambios.", msg);
            }
          );
          return;
        }

        if (action === "pick_model_detail") {
          const id = btn.getAttribute("data-id");
          const ds = (state.datasources || []).find((x) => x.id === id);
          if (!id || !ds) return;
          const connId = ($("d_conn") && $("d_conn").value) ? $("d_conn").value : ds.connectionId;
          const companyId = ($("d_company") && $("d_company").value) ? Number($("d_company").value) : undefined;
          const prev = draftUpdatedAt;
          setStatus("info", "Abriendo selector de tabla...");
          runServer(
            "ui_openModelPickerDialog",
            [connId, companyId],
            () => {
              pollDraftChange(prev, () => {
                setStatus("ok", "Tabla actualizada.");
                render();
              });
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir selector de tabla.", msg);
            }
          );
          return;
        }

        if (action === "pick_columns_detail") {
          const id = btn.getAttribute("data-id");
          const ds = (state.datasources || []).find((x) => x.id === id);
          if (!id || !ds) return;
          const connId = ($("d_conn") && $("d_conn").value) ? $("d_conn").value : ds.connectionId;
          const model = ($("ds_model").value || "").trim() || ds.odooModel;
          const companyId = ($("d_company") && $("d_company").value) ? Number($("d_company").value) : undefined;
          const prev = draftUpdatedAt;
          setStatus("info", "Abriendo selector de columnas...");
          runServer(
            "ui_openColumnsPickerDialog",
            [connId, model, companyId],
            () => {
              pollDraftChange(prev, () => {
                setStatus("ok", "Columnas actualizadas.");
                render();
              });
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir selector de columnas.", msg);
            }
          );
          return;
        }

        if (action === "pick_filters_detail") {
          const id = btn.getAttribute("data-id");
          const ds = (state.datasources || []).find((x) => x.id === id);
          if (!id || !ds) return;
          const connId = ($("d_conn") && $("d_conn").value) ? $("d_conn").value : ds.connectionId;
          const model = ($("ds_model").value || "").trim() || ds.odooModel;
          const companyId = ($("d_company") && $("d_company").value) ? Number($("d_company").value) : undefined;
          const prev = draftUpdatedAt;
          const curDomain = ($("d_domain") && $("d_domain").value) ? $("d_domain").value : (ds.domain || "");
          setStatus("info", "Abriendo editor de filtros...");
          runServer(
            "ui_openFilterBuilderDialog",
            [connId, model, curDomain, companyId],
            () => {
              pollDraftChange(prev, () => {
                setStatus("ok", "Filtros actualizados.");
                render();
              });
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir el editor de filtros.", msg);
            }
          );
          return;
        }

        if (action === "copy_error") {
          const id = btn.getAttribute("data-id");
          const ds = (state.datasources || []).find((x) => x.id === id);
          const text = ds && ds.lastRun && ds.lastRun.error ? ds.lastRun.error : "";
          const ok = safeCopyToClipboard(text);
          setStatus(ok ? "ok" : "err", ok ? "Copiado." : "No pude copiar.", ok ? "" : "Copia manualmente el texto del error.");
          return;
        }

        if (action === "menu_ds") {
          const id = btn.getAttribute("data-id") || "";
          openMenuForDatasourceId = openMenuForDatasourceId === id ? "" : id;
          render();
          return;
        }

        if (action === "open_ds") {
          const id = btn.getAttribute("data-id") || "";
          if (id) setDatasourceDetail(id);
          return;
        }

        if (action === "back_ds") {
          setDatasourceDetail("");
          return;
        }

        if (action === "conn_use") {
          const id = btn.getAttribute("data-id");
          if (!id) return;
          try { $("login_conn").value = id; } catch (_) {}
          try { $("ds_conn").value = id; } catch (_) {}
          try {
            const c = (state.connections || []).find((x) => x.id === id);
            if (c && c.savedUsername) $("login_user").value = c.savedUsername;
            if (c && c.hasCredential) {
              setView("extracts");
              setStatus("ok", "Conexion seleccionada. Ahora crea/edita una extraccion.");
            } else {
              setView("connections");
              setStatus("info", "Conexion seleccionada. Falta login (seccion Login).");
            }
          } catch (_) {}
          tryLoadCompaniesForConnection(id);
          return;
        }

        if (action === "conn_new_ds") {
          const id = btn.getAttribute("data-id");
          if (!id) return;
          const c = (state.connections || []).find((x) => x.id === id);
          try { $("login_conn").value = id; } catch (_) {}
          try { $("ds_conn").value = id; } catch (_) {}
          try {
            if (c && c.savedUsername) $("login_user").value = c.savedUsername;
          } catch (_) {}

          tryLoadCompaniesForConnection(id);

          if (!c || !c.hasCredential) {
            setView("connections");
            setStatus("err", "Para crear una extraccion primero hace login en esta conexion.");
            try { $("login_user").focus(); } catch (_) {}
            return;
          }

          // Go to extracts and open the model picker (fastest flow).
          setView("extracts");
          setStatus("info", "Nueva extraccion: elige una tabla...");
          const prev = draftUpdatedAt;
          const companyId = $("ds_company") ? Number($("ds_company").value || "") || undefined : undefined;
          runServer(
            "ui_openModelPickerDialog",
            [id, companyId],
            () => {
              pollDraftChange(prev, () => {
                setStatus("ok", "Tabla seleccionada. Ahora elige columnas.");
                try { $("btnOpenColumnsPicker").click(); } catch (_) {}
              });
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir el selector de tabla.", msg);
            }
          );
          return;
        }

        if (action === "conn_edit") {
          const id = btn.getAttribute("data-id");
          const c = (state.connections || []).find((x) => x.id === id);
          if (!c) return setStatus("err", "No encontre la conexion.", `Connection: ${id}`);
          setView("connections");
          setConnEditingUI(c);
          setStatus("info", "Editando conexion...", c.title || c.name);
          return;
        }

        if (action === "conn_logout") {
          const id = btn.getAttribute("data-id");
          const ok = confirm("Borrar credenciales guardadas de esta conexion?\n\nLuego vas a tener que hacer login de nuevo.");
          if (!ok) return;
          btn.disabled = true;
          setStatus("info", "Borrando credenciales...");
          runServer(
            "api_clearCredential",
            [{ connectionId: id }],
            () => {
              btn.disabled = false;
              setStatus("ok", "Credenciales borradas.");
              loadBootstrap();
            },
            (e) => {
              btn.disabled = false;
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude borrar credenciales.", msg);
            }
          );
          return;
        }

        if (action === "conn_delete") {
          const id = btn.getAttribute("data-id");
          const ok = confirm("Borrar esta conexion?\n\nEsto tambien borra todas las extracciones que usan esa conexion.");
          if (!ok) return;
          btn.disabled = true;
          setStatus("info", "Borrando conexion...");
          runServer(
            "api_deleteConnection",
            [{ connectionId: id }],
            () => {
              btn.disabled = false;
              setConnEditingUI(null);
              setStatus("ok", "Conexion borrada.");
              loadBootstrap();
            },
            (e) => {
              btn.disabled = false;
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude borrar la conexion.", msg);
            }
          );
          return;
        }

        if (action === "schedule") {
          const id = btn.getAttribute("data-id");
          setStatus("info", "Abriendo timer...", `Datasource: ${id}`);
          runServer(
            "ui_openScheduleDialog",
            [id],
            () => {
              // Best effort refresh after user closes dialog (we can't reliably detect close).
              setTimeout(loadBootstrap, 1200);
              setTimeout(loadBootstrap, 3000);
              setStatus("ok", "Timer abierto. Cuando guardes, se actualiza la lista.");
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir el timer.", msg);
            }
          );
          return;
        }

        if (action === "history") {
          const id = btn.getAttribute("data-id");
          setStatus("info", "Abriendo historial...", `Datasource: ${id}`);
          runServer(
            "ui_openHistoryDialog",
            [id],
            () => {
              setStatus("ok", "Historial abierto.");
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir el historial.", msg);
            }
          );
          return;
        }

        if (action === "duplicate") {
          const id = btn.getAttribute("data-id");
          btn.disabled = true;
          setStatus("info", "Duplicando extraccion...", `Datasource: ${id}`);
          runServer(
            "api_duplicateDatasource",
            [{ datasourceId: id }],
            (res) => {
              setStatus("ok", "Extraccion duplicada.", `Nueva hoja: ${res.sheetName}`);
              btn.disabled = false;
              loadBootstrap();
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude duplicar.", msg);
              btn.disabled = false;
            }
          );
          return;
        }

        if (action === "rename") {
          const id = btn.getAttribute("data-id");
          setStatus("info", "Abriendo renombrar...", `Datasource: ${id}`);
          runServer(
            "ui_openRenameDatasourceDialog",
            [id],
            () => {
              // Best effort refresh after user closes dialog.
              setTimeout(loadBootstrap, 1200);
              setTimeout(loadBootstrap, 3000);
              setStatus("ok", "Renombrar abierto.");
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir renombrar.", msg);
            }
          );
          return;
        }

        if (action === "edit") {
          const id = btn.getAttribute("data-id");
          const ds = (state.datasources || []).find((x) => x.id === id);
          if (!ds) return setStatus("err", "No encontre la extraccion para editar.", `Datasource: ${id}`);
          setStatus("info", "Cargando extraccion para editar...", `${ds.sheetName} | ${ds.odooModel}`);

          // Populate form.
          try {
            $("ds_sheet").value = ds.sheetName;
          } catch (_) {}
          try {
            $("ds_conn").value = ds.connectionId;
          } catch (_) {}
          try {
            $("ds_title").value = ds.title || "";
          } catch (_) {}
          $("ds_limit").value = String(ds.limit || 80);
          $("ds_order").value = ds.orderBy || "";
          $("ds_domain").value = ds.domain || "";
          $("ds_mode").value = ds.writeMode || "REPLACE";
          $("ds_header").checked = Boolean(ds.header);
          renderDsCompanyBox(ds.connectionId, ds.companyId);

          // Sync draft (so dialogs open with current selection).
          const connId = ds.connectionId;
          const model = ds.odooModel;
          const modelName = model;
          const fields = (ds.fields || []).slice().sort((a, b) => (a.order || 0) - (b.order || 0)).map((f, idx) => ({
            fieldName: f.fieldName,
            label: f.label || f.fieldName,
            order: idx,
            type: f.type || "",
          }));

          runServer(
            "api_setDraftModel",
            [{ connectionId: connId, model, modelName }],
            (draft1) => {
              applyDraft(draft1);
              runServer(
                "api_setDraftFields",
                [{ connectionId: connId, model, fields }],
                (draft2) => {
                  applyDraft(draft2);
                  runServer(
                    "api_setDraftDomain",
                    [{ connectionId: connId, model, domain: ds.domain || "" }],
                    (draft3) => {
                      applyDraft(draft3);
                      setEditingUI(ds);
                      setStatus("ok", "Listo para editar. Cambia lo que quieras y toca Guardar cambios.");
                    },
                    (e2) => {
                      // Domain is optional; don't block edit if invalid.
                      applyDraft(draft2);
                      setEditingUI(ds);
                      const msg2 = (e2 && (e2.message || String(e2))) || "Error";
                      setStatus("info", "Listo para editar (nota: el filtro avanzado tiene un problema).", msg2);
                    }
                  );
                },
                (e) => {
                  const msg = (e && (e.message || String(e))) || "Error";
                  setStatus("err", "No pude cargar las columnas para editar.", msg);
                }
              );
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude cargar la tabla para editar.", msg);
            }
          );
          return;
        }

        if (action === "refresh") {
          const id = btn.getAttribute("data-id");
          const msgEl = $("ds_item_msg_" + id);
          setMsg(msgEl, "", "");
          btn.disabled = true;
          setStatus("info", "Refrescando...", `Datasource: ${id}`);
          runServer(
            "api_refreshDatasource",
            [id, { automated: false }],
            (res) => {
              setMsg(msgEl, "ok", `OK: ${res.rowsFetched} filas`);
              setStatus("ok", `Refresco OK: ${res.rowsFetched} filas.`);
              btn.disabled = false;
              loadBootstrap();
            },
            (e) => {
              setMsg(msgEl, "err", (e && (e.message || String(e))) || "Error");
              setStatus("err", "Fallo el refresco.", e && (e.message || String(e)));
              btn.disabled = false;
            },
            { timeoutMs: 120000 }
          );
        }

        if (action === "delete") {
          const id = btn.getAttribute("data-id");
          const ok = confirm("Borrar esta extraccion?\n\nEsto solo borra la configuracion. No borra la hoja ni los datos.");
          if (!ok) return;
          btn.disabled = true;
          setStatus("info", "Borrando extraccion...", `Datasource: ${id}`);
          runServer(
            "api_deleteDatasource",
            [{ datasourceId: id }],
            () => {
              setStatus("ok", "Extraccion borrada.");
              btn.disabled = false;
              loadBootstrap();
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude borrar la extraccion.", msg);
              btn.disabled = false;
            }
          );
        }
      });

      $("btnClearStatus").addEventListener("click", () => {
        const bar = $("statusBar");
        if (!bar) return;
        bar.className = "status";
        $("statusText").textContent = "";
        $("statusDetail").textContent = "";
      });

      window.addEventListener("error", (ev) => {
        const msg = (ev && ev.message) || "Error de JavaScript en la interfaz.";
        const where = ev && ev.filename ? `${ev.filename}:${ev.lineno || ""}` : "";
        setStatus("err", msg, where);
      });
      window.addEventListener("unhandledrejection", (ev) => {
        const reason = (ev && ev.reason && (ev.reason.message || String(ev.reason))) || "Promise rechazada.";
        setStatus("err", "Error en la interfaz.", reason);
      });

      try {
        $("uiBuild").textContent = UI_BUILD;
      } catch (_) {}

      $("tab_extracts").addEventListener("click", () => setView("extracts"));
      $("tab_connections").addEventListener("click", () => setView("connections"));
      $("tab_help").addEventListener("click", () => setView("help"));

      // Default view
      setView("extracts");

      loadBootstrap();
    </script>
  </body>
</html>
