<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <style>
      :root {
        --bg: #f8fafc;
        --panel: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --line: rgba(15, 23, 42, 0.12);
        --accent: #16a34a;
        --danger: #dc2626;
        --info: #2563eb;
      }
      html, body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font: 13px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      .wrap { padding: 12px; }
      h1 { font-size: 14px; margin: 0 0 8px; }
      h2 { font-size: 12px; margin: 0 0 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
      h3 { font-size: 12px; margin: 12px 0 8px; }

      .card {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .row { display: flex; gap: 8px; align-items: center; }
      .col { flex: 1; }
      .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .sep { height: 1px; background: var(--line); margin: 10px 0; }

      label { display: block; color: var(--muted); margin: 6px 0 2px; font-size: 12px; }
      input, select, textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        background: #fff;
        border: 1px solid rgba(15, 23, 42, 0.18);
        border-radius: 8px;
        color: var(--text);
        outline: none;
      }
      textarea { resize: vertical; min-height: 64px; }
      input::placeholder, textarea::placeholder { color: rgba(15,23,42,0.35); }

      button {
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      button.primary { border-color: rgba(22,163,74,0.35); background: rgba(22,163,74,0.10); }
      button.danger { border-color: rgba(220,38,38,0.35); background: rgba(220,38,38,0.08); }
      button:disabled { opacity: 0.55; cursor: not-allowed; }

      .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
      .msg { margin-top: 8px; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--line); background: rgba(15,23,42,0.02); }
      .msg.ok { border-color: rgba(22,163,74,0.35); }
      .msg.err { border-color: rgba(220,38,38,0.35); }

      .list { display: flex; flex-direction: column; gap: 8px; }
      .item { padding: 8px 10px; border: 1px solid var(--line); border-radius: 10px; background: rgba(15,23,42,0.02); }
      .title { font-weight: 600; }
      .meta { color: var(--muted); font-size: 12px; margin-top: 2px; }
      .pill { display: inline-flex; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--line); color: var(--muted); font-size: 12px; }
      .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; border: 1px solid var(--line); padding: 1px 6px; border-radius: 7px; background: rgba(15,23,42,0.02); }

      .status {
        display: none;
        margin: 8px 0 10px;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #fff;
      }
      .status.show { display: block; }
      .status.ok { border-color: rgba(22,163,74,0.35); }
      .status.err { border-color: rgba(220,38,38,0.35); }
      .status.info { border-color: rgba(37,99,235,0.35); }
      .status .row { justify-content: space-between; }
      .status .small { color: var(--muted); font-size: 12px; margin-top: 2px; }

      .pills { display: flex; flex-wrap: wrap; gap: 6px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Odoo O2Sheets <span class="pill" id="uiBuild"></span></h1>
      <div class="hint" id="ctx"></div>
      <div class="status" id="statusBar">
        <div class="row">
          <div class="title" id="statusText"></div>
          <button id="btnClearStatus" type="button">Limpiar</button>
        </div>
        <div class="small" id="statusDetail"></div>
      </div>

      <div class="card">
        <h2>Guia Rapida</h2>
        <div class="hint">
          1) Crea una conexion (URL + Database).<br />
          2) Hace login.<br />
          3) Crea una extraccion: elegi modelo y campos, guarda, y luego <span class="kbd">Refresh</span>.
        </div>
      </div>

      <div class="card">
        <h2>1) Conexion</h2>
        <label>Odoo URL (publica)</label>
        <input id="c_url" placeholder="https://xxxxx.odoo.com o https://xxxxx.dev.odoo.com" />
        <label>Database (nombre exacto)</label>
        <input id="c_db" placeholder="ej: unika-sa-motor-haus1-main-25276166" />

        <div class="row" style="margin-top: 8px;">
          <button id="btnTestUrl">Probar URL</button>
          <button class="primary" id="btnCreateConn">Guardar conexion</button>
          <button id="btnReload">Recargar</button>
        </div>
        <div id="connMsg"></div>

        <div class="sep"></div>
        <div class="hint">Conexiones guardadas en esta planilla:</div>
        <div class="list" id="connectionsList"></div>
      </div>

      <div class="card">
        <h2>2) Login</h2>
        <label>Conexion</label>
        <select id="login_conn"></select>
        <label>Usuario Odoo</label>
        <input id="login_user" placeholder="ej: admin o tu-email@empresa.com" />
        <label>Password o API Key</label>
        <input id="login_pass" type="password" placeholder="password o api key" />
        <div class="hint">Podes usar Password o una API Key de Odoo (recomendado). Las credenciales se guardan siempre para que funcione el timer.</div>

        <div id="companyBox" style="display:none; margin-top:10px;">
          <label>Company (multiempresa)</label>
          <select id="login_company"></select>
          <div class="hint">Si tu usuario tiene multiples empresas, elegi cual usar para extraer datos.</div>
        </div>
        <div class="row" style="margin-top: 8px;">
          <button class="primary" id="btnLogin">Probar login</button>
        </div>
        <div id="loginMsg"></div>
      </div>

      <div class="card">
        <h2>3) Crear Extraccion</h2>
        <div class="grid2">
          <div>
            <label>Nombre (opcional)</label>
            <input id="ds_title" placeholder="Ej: Ventas (res.partner)" />

            <label>Hoja destino</label>
            <select id="ds_sheet"></select>
          </div>
          <div>
            <label>Conexion</label>
            <select id="ds_conn"></select>

            <div id="dsCompanyBox" style="display:none; margin-top:10px;">
              <label>Company (opcional)</label>
              <select id="ds_company"></select>
              <div class="hint">Si lo dejas en "Default", usa la company de la conexion (Login).</div>
            </div>
          </div>
        </div>

        <h3>Tabla (modelo)</h3>
        <input id="ds_model" type="hidden" />
        <div class="row" style="margin-top: 8px;">
          <div class="col">
            <div class="title" id="chosenModelTitle">Sin tabla seleccionada</div>
            <div class="meta" id="chosenModelMeta">Usa "Seleccionar tabla" para buscar por nombre.</div>
          </div>
          <button class="primary" id="btnOpenModelPicker">Seleccionar tabla</button>
        </div>

        <h3>Columnas</h3>
        <div class="row" style="margin-top: 8px;">
          <div class="hint col" id="chosenFieldsHint">0 columnas seleccionadas.</div>
          <button class="primary" id="btnOpenColumnsPicker" disabled>Elegir columnas</button>
          <button id="btnClearDraft" type="button">Limpiar</button>
        </div>
        <div class="pills" id="chosenFieldsPills" style="margin-top: 8px;"></div>

        <div class="sep"></div>
        <div class="grid2">
          <div>
            <label>Limite</label>
            <input id="ds_limit" type="number" value="80" />
          </div>
          <div>
            <label>Orden (opcional)</label>
            <input id="ds_order" placeholder="id desc" />
          </div>
        </div>
        <label>Filtro (Domain) opcional (JSON)</label>
        <textarea id="ds_domain" placeholder='[["active","=",true]]'></textarea>
        <div class="grid2">
          <div>
            <label>Modo de escritura</label>
            <select id="ds_mode">
              <option value="REPLACE">REPLACE</option>
              <option value="APPEND">APPEND</option>
            </select>
          </div>
          <div>
            <label><input type="checkbox" id="ds_header" checked /> Escribir encabezados</label>
          </div>
        </div>
        <div class="row" style="margin-top: 8px;">
          <button class="primary" id="btnCreateDs">Guardar extraccion</button>
        </div>
        <div class="row" id="editBar" style="display:none; margin-top: 8px; align-items:center; justify-content:space-between;">
          <div class="hint" id="editLabel"></div>
          <button class="danger" id="btnCancelEdit" type="button">Cancelar edicion</button>
        </div>
        <div id="dsMsg"></div>
      </div>

      <div class="card">
        <h2>Mis Extracciones</h2>
        <div class="list" id="datasourcesList"></div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const UI_BUILD = "2026-02-09m";

      let state = { context: null, connections: [], datasources: [], draft: null };
      let selectedFields = []; // [{fieldName,label,type}]
      let chosenModel = { model: "", name: "" };
      let editingDatasourceId = "";
      let companyByConn = {}; // connId -> { companies: [{id,name}], companyId }
      let dsCompanies = []; // companies for extraction editor dropdown

      function setStatus(kind, text, detail) {
        const bar = $("statusBar");
        const txt = $("statusText");
        const det = $("statusDetail");
        if (!bar || !txt || !det) return;
        const k = kind === "ok" || kind === "err" || kind === "info" ? kind : "info";
        bar.className = `status show ${k}`;
        txt.textContent = text ? String(text) : "";
        det.textContent = detail ? String(detail) : "";
      }

      function setMsg(el, kind, text) {
        if (!el) {
          if (text) setStatus(kind === "ok" ? "ok" : "err", text);
          return;
        }
        el.innerHTML = "";
        if (!text) return;
        const d = document.createElement("div");
        d.className = "msg " + (kind === "ok" ? "ok" : "err");
        d.textContent = text;
        el.appendChild(d);
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderCompanyBox(connId) {
        const box = $("companyBox");
        const sel = $("login_company");
        if (!box || !sel) return;
        const entry = companyByConn[connId];
        const companies = entry && entry.companies ? entry.companies : [];
        if (!companies || companies.length <= 1) {
          box.style.display = "none";
          return;
        }
        box.style.display = "block";
        sel.innerHTML = "";
        companies.forEach((c) => {
          const o = document.createElement("option");
          o.value = String(c.id);
          o.textContent = `${c.name} (#${c.id})`;
          sel.appendChild(o);
        });
        const current = entry.companyId ? String(entry.companyId) : "";
        if (current) sel.value = current;
      }

      function renderDsCompanyBox(connId, selectedCompanyId) {
        const box = $("dsCompanyBox");
        const sel = $("ds_company");
        if (!box || !sel) return;
        const entry = companyByConn[connId];
        const companies = entry && entry.companies ? entry.companies : [];
        dsCompanies = companies || [];
        if (!companies || companies.length <= 1) {
          box.style.display = "none";
          sel.innerHTML = "";
          return;
        }
        box.style.display = "block";
        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Default (de la conexion)";
        sel.appendChild(opt0);
        companies.forEach((c) => {
          const o = document.createElement("option");
          o.value = String(c.id);
          o.textContent = `${c.name} (#${c.id})`;
          sel.appendChild(o);
        });
        if (selectedCompanyId) sel.value = String(selectedCompanyId);
        else sel.value = "";
      }

      function runServer(fnName, args, onOk, onErr, opts) {
        const timeoutMs = (opts && opts.timeoutMs) || 45000;
        const g = window.google;
        if (!(g && g.script && g.script.run)) {
          setStatus(
            "err",
            "No se encontro google.script.run (esto suele pasar si el sidebar no se abrio desde Google Sheets)."
          );
          return;
        }

        let done = false;
        const t = setTimeout(() => {
          if (done) return;
          setStatus("err", "Timeout esperando respuesta del servidor.", `Funcion: ${fnName}`);
        }, timeoutMs);

        const success = (res) => {
          done = true;
          clearTimeout(t);
          if (onOk) onOk(res);
        };
        const failure = (e) => {
          done = true;
          clearTimeout(t);
          const msg = (e && (e.message || (e.toString && e.toString()))) || String(e || "Error");
          if (onErr) onErr(e);
          else setStatus("err", msg);
        };

        try {
          const runner = g.script.run.withSuccessHandler(success).withFailureHandler(failure);
          const arr = Array.isArray(args) ? args : args === undefined ? [] : [args];
          const fn = runner && runner[fnName];
          if (typeof fn !== "function") {
            clearTimeout(t);
            setStatus(
              "err",
              "Error ejecutando llamada al servidor.",
              `La funcion "${fnName}" no existe. Probable version vieja del add-on. Recarga la planilla (F5), cierra y vuelve a abrir el sidebar. UI=${UI_BUILD}.`
            );
            return;
          }
          fn.apply(runner, arr);
        } catch (e) {
          clearTimeout(t);
          setStatus("err", "Error ejecutando llamada al servidor.", e && (e.message || String(e)));
        }
      }

      function loadBootstrap() {
        setStatus("info", "Cargando estado...");
        runServer(
          "api_getBootstrap",
          [],
          (res) => {
            state = res;
            $("ctx").textContent = `Doc: ${res.context.spreadsheetId} | Usuario Google: ${res.context.userEmail}`;
            render();
            refreshSheets();
            if (res.draft) applyDraft(res.draft);
            setStatus("ok", "Listo.");
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setMsg($("connMsg"), "err", msg);
            setStatus("err", "No se pudo cargar el estado.", msg);
          }
        );
      }

      function updateChosenModelUI() {
        const model = ($("ds_model").value || "").trim();
        const title = $("chosenModelTitle");
        const meta = $("chosenModelMeta");
        if (!model) {
          title.textContent = "Sin tabla seleccionada";
          meta.textContent = 'Usa "Seleccionar tabla" para buscar por nombre.';
          $("btnOpenColumnsPicker").disabled = true;
          return;
        }
        title.textContent = chosenModel.name ? chosenModel.name : model;
        meta.textContent = `Modelo tecnico: ${model}`;
        $("btnOpenColumnsPicker").disabled = false;
      }

      function updateChosenFieldsUI() {
        const hint = $("chosenFieldsHint");
        const pills = $("chosenFieldsPills");
        const n = selectedFields.length;
        hint.textContent = `${n} columna${n === 1 ? "" : "s"} seleccionada${n === 1 ? "" : "s"}.`;
        pills.innerHTML = "";
        selectedFields.slice(0, 10).forEach((f) => {
          const p = document.createElement("span");
          p.className = "pill";
          p.textContent = f.fieldName;
          pills.appendChild(p);
        });
        if (n > 10) {
          const p = document.createElement("span");
          p.className = "pill";
          p.textContent = `+${n - 10} mas`;
          pills.appendChild(p);
        }
      }

      function setEditingUI(ds) {
        const bar = $("editBar");
        const label = $("editLabel");
        const btn = $("btnCreateDs");
        if (!bar || !label || !btn) return;
        if (!ds) {
          editingDatasourceId = "";
          bar.style.display = "none";
          btn.textContent = "Guardar extraccion";
          return;
        }
        editingDatasourceId = ds.id;
        bar.style.display = "flex";
        label.textContent = `Editando: ${ds.sheetName} | ${ds.odooModel}`;
        btn.textContent = "Guardar cambios";
      }

      function render() {
        // Connections list
        const cl = $("connectionsList");
        cl.innerHTML = "";
        if (!state.connections.length) {
          const d = document.createElement("div");
          d.className = "hint";
          d.textContent = "No hay conexiones todavia.";
          cl.appendChild(d);
        } else {
          state.connections.forEach((c) => {
            const it = document.createElement("div");
            it.className = "item";
            it.innerHTML = `
              <div class="title">${escapeHtml(c.title || c.name)}</div>
              <div class="meta">${escapeHtml(c.odooUrl)} | DB: ${escapeHtml(c.odooDb)}</div>
            `;
            cl.appendChild(it);
          });
        }

        // Connection selects
        const prevLogin = $("login_conn").value;
        const prevDs = $("ds_conn").value;
        for (const sid of ["login_conn", "ds_conn"]) {
          const sel = $(sid);
          sel.innerHTML = "";
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = "Seleccionar...";
          sel.appendChild(opt0);
          state.connections.forEach((c) => {
            const o = document.createElement("option");
            o.value = c.id;
            o.textContent = c.title || c.name;
            sel.appendChild(o);
          });
        }
        if (prevLogin) $("login_conn").value = prevLogin;
        if (prevDs) $("ds_conn").value = prevDs;
        if (!prevLogin && state.connections.length === 1) $("login_conn").value = state.connections[0].id;
        if (!prevDs && state.connections.length === 1) $("ds_conn").value = state.connections[0].id;

        // Datasources list
        const dl = $("datasourcesList");
        dl.innerHTML = "";
        if (!state.datasources.length) {
          const d = document.createElement("div");
          d.className = "hint";
          d.textContent = "No hay extracciones todavia.";
          dl.appendChild(d);
        } else {
          state.datasources.forEach((ds) => {
            const it = document.createElement("div");
            it.className = "item";
            const last = ds.lastRun ? `${ds.lastRun.status} @ ${ds.lastRun.at} (${ds.lastRun.rows} filas)` : "nunca";
            const auto = ds.schedulerEnabled ? "AUTO: ON" : "AUTO: OFF";
            const autoMeta = ds.schedulerEnabled
              ? `Timezone: ${(ds.schedulerConfig && ds.schedulerConfig.timezone) || "?"} | Horas: ${((ds.schedulerConfig && ds.schedulerConfig.hours) || []).join(",") || "todas"}`
              : "Auto refresh desactivado.";
            const nextRun = ds.nextRunAt ? `Proxima: ${ds.nextRunAt}` : "";
            const title = ds.title ? ds.title : ds.sheetName;
            const company = ds.companyId ? `Company: #${ds.companyId}` : "";
            it.innerHTML = `
              <div class="title">${escapeHtml(title)} <span class="pill">${escapeHtml(ds.odooModel)}</span></div>
              <div class="meta">Hoja: ${escapeHtml(ds.sheetName)} ${company ? "| " + escapeHtml(company) : ""}</div>
              <div class="meta">Campos: ${escapeHtml(ds.fields.map((f) => f.fieldName).join(", "))}</div>
              <div class="meta">${escapeHtml(auto)} | ${escapeHtml(autoMeta)}</div>
              ${nextRun ? `<div class="meta">${escapeHtml(nextRun)}</div>` : ""}
              <div class="meta">Ultima ejecucion: ${escapeHtml(last)}</div>
               <div class="row" style="margin-top:8px;">
                 <button class="primary" data-action="refresh" data-id="${ds.id}">Refresh</button>
                 <button data-action="edit" data-id="${ds.id}">Editar</button>
                 <button data-action="schedule" data-id="${ds.id}">Timer</button>
                 <button data-action="history" data-id="${ds.id}">Historial</button>
                 <button data-action="duplicate" data-id="${ds.id}">Duplicar</button>
                 <button data-action="rename" data-id="${ds.id}">Renombrar</button>
                 <button class="danger" data-action="delete" data-id="${ds.id}">Borrar</button>
               </div>
               <div id="ds_item_msg_${ds.id}"></div>
             `;
             dl.appendChild(it);
           });
         }

        updateChosenModelUI();
        updateChosenFieldsUI();
      }

      function tryLoadCompaniesForConnection(connId) {
        if (!connId) return;
        runServer(
          "api_getCompanies",
          [{ connectionId: connId }],
          (res) => {
            companyByConn[connId] = { companies: res.companies || [], companyId: res.companyId };
            renderCompanyBox(connId);
            renderDsCompanyBox(connId);
          },
          () => {
            // Ignore if not logged in yet.
            try {
              const box = $("companyBox");
              if (box) box.style.display = "none";
              const b2 = $("dsCompanyBox");
              if (b2) b2.style.display = "none";
            } catch (_) {}
          }
        );
      }

      function refreshSheets() {
        runServer(
          "api_listSheets",
          [],
          (names) => {
            const sel = $("ds_sheet");
            sel.innerHTML = "";
            names.forEach((n) => {
              const o = document.createElement("option");
              o.value = n;
              o.textContent = n;
              sel.appendChild(o);
            });
          },
          (e) => setMsg($("dsMsg"), "err", (e && (e.message || String(e))) || "Error")
        );
      }

      function suggestDbFromUrl() {
        const url = ($("c_url").value || "").trim();
        if (!url) return;
        try {
          const u = new URL(url.replace(/\/+$/, ""));
          const host = u.hostname || "";
          if (host.endsWith(".odoo.com")) {
            const sub = host.split(".")[0];
            if (sub && !$("c_db").value.trim()) $("c_db").value = sub;
          }
        } catch (_) {}
      }

      $("c_url").addEventListener("blur", suggestDbFromUrl);

      $("btnReload").addEventListener("click", loadBootstrap);
      let draftUpdatedAt = "";

      $("login_conn").addEventListener("change", () => {
        const connId = $("login_conn").value;
        tryLoadCompaniesForConnection(connId);
      });

      $("ds_conn").addEventListener("change", () => {
        const connId = $("ds_conn").value;
        if (!connId) return;
        tryLoadCompaniesForConnection(connId);
        // Keep the extraction-level selector in sync (if companies are available).
        renderDsCompanyBox(connId);
      });

      $("login_company").addEventListener("change", () => {
        const connId = $("login_conn").value;
        const companyId = $("login_company").value;
        if (!connId) return;
        setStatus("info", "Guardando company...", `Company: ${companyId}`);
        runServer(
          "api_setConnectionCompany",
          [{ connectionId: connId, companyId: companyId ? Number(companyId) : undefined }],
          () => {
            if (companyByConn[connId]) companyByConn[connId].companyId = companyId ? Number(companyId) : undefined;
            setStatus("ok", "Company guardada.");
            loadBootstrap();
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No pude guardar la company.", msg);
          }
        );
      });

      function applyDraft(draft) {
        if (!draft) return;
        draftUpdatedAt = draft.updatedAt || draftUpdatedAt;

        if (draft.connectionId) {
          try {
            $("ds_conn").value = draft.connectionId;
          } catch (_) {}
        }

        const model = (draft.model || "").trim();
        if (model) {
          $("ds_model").value = model;
          chosenModel = { model, name: (draft.modelName || "").trim() || model };
        }

        selectedFields = (draft.fields || [])
          .slice()
          .sort((a, b) => (a.order || 0) - (b.order || 0))
          .map((f) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, type: f.type || "" }));

        updateChosenModelUI();
        updateChosenFieldsUI();
      }

      function pollDraftChange(prevUpdatedAt, onChanged) {
        const started = Date.now();
        const tick = () => {
          runServer(
            "api_getDraftExtraction",
            [],
            (draft) => {
              const cur = (draft && draft.updatedAt) || "";
              if (cur && cur !== prevUpdatedAt) {
                applyDraft(draft);
                if (onChanged) onChanged(draft);
                return;
              }
              if (Date.now() - started > 60 * 1000) {
                setStatus("info", "No se detectaron cambios (si elegiste algo, toca Recargar).");
                return;
              }
              setTimeout(tick, 700);
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude leer el draft.", msg);
            }
          );
        };
        tick();
      }

      $("btnOpenModelPicker").addEventListener("click", () => {
        const connId = $("ds_conn").value || $("login_conn").value;
        if (!connId) return setStatus("err", "Primero selecciona una conexion y hace login.");
        const prev = draftUpdatedAt;
        const companyId = $("ds_company") ? Number($("ds_company").value || "") || undefined : undefined;
        setStatus("info", "Abriendo selector de tabla...");
        runServer(
          "ui_openModelPickerDialog",
          [connId, companyId],
          () => {
            pollDraftChange(prev, () => {
              // After picking a table, open columns picker automatically (most intuitive flow).
              const model = ($("ds_model").value || "").trim();
              if (!model) return;
              if (selectedFields.length) return setStatus("ok", "Tabla seleccionada.");
              setStatus("info", "Tabla seleccionada. Abriendo selector de columnas...");
              const prevCols = draftUpdatedAt;
              setTimeout(() => {
                runServer(
                  "ui_openColumnsPickerDialog",
                  [connId, model, companyId],
                  () => pollDraftChange(prevCols, () => setStatus("ok", "Columnas actualizadas.")),
                  (e) => {
                    const msg = (e && (e.message || String(e))) || "Error";
                    setStatus("err", "No pude abrir el selector de columnas.", msg);
                  }
                );
              }, 250);
            });
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No pude abrir el selector.", msg);
          }
        );
      });

      $("btnOpenColumnsPicker").addEventListener("click", () => {
        const connId = $("ds_conn").value || $("login_conn").value;
        if (!connId) return setStatus("err", "Primero selecciona una conexion y hace login.");
        const model = ($("ds_model").value || "").trim();
        if (!model) return setStatus("err", "Primero selecciona una tabla.");
        const prev = draftUpdatedAt;
        const companyId = $("ds_company") ? Number($("ds_company").value || "") || undefined : undefined;
        setStatus("info", "Abriendo selector de columnas...");
        runServer(
          "ui_openColumnsPickerDialog",
          [connId, model, companyId],
          () => {
            pollDraftChange(prev, () => setStatus("ok", "Columnas actualizadas."));
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No pude abrir el selector.", msg);
          }
        );
      });

      $("btnClearDraft").addEventListener("click", () => {
        setStatus("info", "Limpiando seleccion...");
        runServer(
          "api_clearDraftExtraction",
          [],
          () => {
            draftUpdatedAt = "";
            try { $("ds_title").value = ""; } catch (_) {}
            $("ds_model").value = "";
            chosenModel = { model: "", name: "" };
            selectedFields = [];
            updateChosenModelUI();
            updateChosenFieldsUI();
            setEditingUI(null);
            setStatus("ok", "Seleccion limpiada.");
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setStatus("err", "No se pudo limpiar.", msg);
          }
        );
      });

      $("btnCancelEdit").addEventListener("click", () => {
        setEditingUI(null);
        setMsg($("dsMsg"), "ok", "Edicion cancelada.");
      });

      $("btnTestUrl").addEventListener("click", () => {
        setMsg($("connMsg"), "", "");
        const url = ($("c_url").value || "").trim();
        if (!url) return setMsg($("connMsg"), "err", "Pega la URL primero.");
        $("btnTestUrl").disabled = true;
        setStatus("info", "Probando URL...", url);
        runServer(
          "api_testOdooUrl",
          [{ odooUrl: url }],
          () => {
            setMsg($("connMsg"), "ok", "URL OK (es accesible).");
            setStatus("ok", "URL OK.");
            $("btnTestUrl").disabled = false;
          },
          (e) => {
            setMsg($("connMsg"), "err", (e && (e.message || String(e))) || "Error");
            setStatus("err", "Fallo al probar URL.", e && (e.message || String(e)));
            $("btnTestUrl").disabled = false;
          }
        );
      });

      $("btnCreateConn").addEventListener("click", () => {
        setMsg($("connMsg"), "", "");
        const url = ($("c_url").value || "").trim();
        const db = ($("c_db").value || "").trim();
        if (!url) return setMsg($("connMsg"), "err", "Falta la URL.");
        if (!db) return setMsg($("connMsg"), "err", "Falta el Database.");
        $("btnCreateConn").disabled = true;
        setStatus("info", "Guardando conexion...", `${url} | DB: ${db}`);
        runServer(
          "api_createConnection",
          [{ odooUrl: url, odooDb: db, storeConnections: false, shareCredentials: false }],
          (conn) => {
            setMsg($("connMsg"), "ok", "Conexion guardada. Ahora hace login.");
            setStatus("ok", "Conexion guardada.");
            loadBootstrap();
            setTimeout(() => {
              try {
                $("login_conn").value = conn.id;
                $("ds_conn").value = conn.id;
              } catch (_) {}
            }, 200);
            $("btnCreateConn").disabled = false;
          },
          (e) => {
            setMsg($("connMsg"), "err", (e && (e.message || String(e))) || "Error");
            setStatus("err", "No se pudo guardar la conexion.", e && (e.message || String(e)));
            $("btnCreateConn").disabled = false;
          }
        );
      });

      $("btnLogin").addEventListener("click", () => {
        setMsg($("loginMsg"), "", "");
        const connId = $("login_conn").value;
        if (!connId) return setMsg($("loginMsg"), "err", "Selecciona una conexion.");
        $("btnLogin").disabled = true;
        setStatus("info", "Probando login...");
        runServer(
          "api_setCredential",
          [
            {
              connectionId: connId,
              odooUsername: $("login_user").value,
              odooPassword: $("login_pass").value,
            },
          ],
          (res) => {
            setMsg($("loginMsg"), "ok", `Login OK (uid=${res.uid}).`);
            setStatus("ok", "Login OK.");
            $("btnLogin").disabled = false;

            try {
              const companies = (res && res.companies) || [];
              const companyId = res && res.companyId;
              companyByConn[connId] = { companies, companyId };
              renderCompanyBox(connId);
            } catch (_) {}

            loadBootstrap();
          },
          (e) => {
            setMsg($("loginMsg"), "err", (e && (e.message || String(e))) || "Error");
            setStatus("err", "Login fallo.", e && (e.message || String(e)));
            $("btnLogin").disabled = false;
          }
        );
      });

      $("btnCreateDs").addEventListener("click", () => {
        setMsg($("dsMsg"), "", "");
        const connId = $("ds_conn").value;
        const sheet = $("ds_sheet").value;
        const model = ($("ds_model").value || "").trim();
        if (!connId) return setMsg($("dsMsg"), "err", "Selecciona conexion.");
        if (!sheet) return setMsg($("dsMsg"), "err", "Selecciona hoja.");
        if (!model) return setMsg($("dsMsg"), "err", "Selecciona una tabla (modelo).");
        if (!selectedFields.length) return setMsg($("dsMsg"), "err", "Elige al menos 1 columna.");

        const fieldArr = selectedFields.map((f, idx) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, order: idx }));
        $("btnCreateDs").disabled = true;
        const isEdit = Boolean(editingDatasourceId);
        setStatus("info", isEdit ? "Guardando cambios..." : "Guardando extraccion...", `${sheet} | ${model}`);
        runServer(
          isEdit ? "api_updateDatasource" : "api_createDatasource",
          [
            {
              datasourceId: editingDatasourceId,
              title: ($("ds_title").value || "").trim(),
              sheetName: sheet,
              connectionId: connId,
              odooModel: model,
              fields: fieldArr,
              limit: Number($("ds_limit").value || 80),
              domain: $("ds_domain").value,
              orderBy: $("ds_order").value,
              writeMode: $("ds_mode").value,
              header: $("ds_header").checked,
              companyId: $("ds_company") ? Number($("ds_company").value || "") || undefined : undefined,
            },
          ],
          () => {
            setMsg($("dsMsg"), "ok", isEdit ? "Cambios guardados." : "Extraccion guardada. Ahora podes apretar Refresh en la lista de abajo.");
            setStatus("ok", isEdit ? "Cambios guardados." : "Extraccion guardada.");
            $("btnCreateDs").disabled = false;
            setEditingUI(null);
            loadBootstrap();
          },
          (e) => {
            setMsg($("dsMsg"), "err", (e && (e.message || String(e))) || "Error");
            setStatus("err", isEdit ? "No se pudieron guardar los cambios." : "No se pudo guardar la extraccion.", e && (e.message || String(e)));
            $("btnCreateDs").disabled = false;
          }
        );
      });

      document.body.addEventListener("click", (ev) => {
        const btn = ev.target && ev.target.closest && ev.target.closest("button[data-action]");
        const action = btn ? btn.getAttribute("data-action") : null;
        if (!action) return;

        if (action === "schedule") {
          const id = btn.getAttribute("data-id");
          setStatus("info", "Abriendo timer...", `Datasource: ${id}`);
          runServer(
            "ui_openScheduleDialog",
            [id],
            () => {
              // Best effort refresh after user closes dialog (we can't reliably detect close).
              setTimeout(loadBootstrap, 1200);
              setTimeout(loadBootstrap, 3000);
              setStatus("ok", "Timer abierto. Cuando guardes, se actualiza la lista.");
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir el timer.", msg);
            }
          );
          return;
        }

        if (action === "history") {
          const id = btn.getAttribute("data-id");
          setStatus("info", "Abriendo historial...", `Datasource: ${id}`);
          runServer(
            "ui_openHistoryDialog",
            [id],
            () => {
              setStatus("ok", "Historial abierto.");
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude abrir el historial.", msg);
            }
          );
          return;
        }

        if (action === "duplicate") {
          const id = btn.getAttribute("data-id");
          btn.disabled = true;
          setStatus("info", "Duplicando extraccion...", `Datasource: ${id}`);
          runServer(
            "api_duplicateDatasource",
            [{ datasourceId: id }],
            (res) => {
              setStatus("ok", "Extraccion duplicada.", `Nueva hoja: ${res.sheetName}`);
              btn.disabled = false;
              loadBootstrap();
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude duplicar.", msg);
              btn.disabled = false;
            }
          );
          return;
        }

        if (action === "rename") {
          const id = btn.getAttribute("data-id");
          const ds = (state.datasources || []).find((x) => x.id === id);
          const prev = ds && ds.title ? ds.title : "";
          const title = prompt("Nuevo nombre (opcional). Deja vacio para usar el nombre de la hoja:", prev);
          if (title === null) return;
          btn.disabled = true;
          setStatus("info", "Renombrando...", `Datasource: ${id}`);
          runServer(
            "api_renameDatasource",
            [{ datasourceId: id, title }],
            () => {
              setStatus("ok", "Nombre guardado.");
              btn.disabled = false;
              loadBootstrap();
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude renombrar.", msg);
              btn.disabled = false;
            }
          );
          return;
        }

        if (action === "edit") {
          const id = btn.getAttribute("data-id");
          const ds = (state.datasources || []).find((x) => x.id === id);
          if (!ds) return setStatus("err", "No encontre la extraccion para editar.", `Datasource: ${id}`);
          setStatus("info", "Cargando extraccion para editar...", `${ds.sheetName} | ${ds.odooModel}`);

          // Populate form.
          try {
            $("ds_sheet").value = ds.sheetName;
          } catch (_) {}
          try {
            $("ds_conn").value = ds.connectionId;
          } catch (_) {}
          try {
            $("ds_title").value = ds.title || "";
          } catch (_) {}
          $("ds_limit").value = String(ds.limit || 80);
          $("ds_order").value = ds.orderBy || "";
          $("ds_domain").value = ds.domain || "";
          $("ds_mode").value = ds.writeMode || "REPLACE";
          $("ds_header").checked = Boolean(ds.header);
          renderDsCompanyBox(ds.connectionId, ds.companyId);

          // Sync draft (so dialogs open with current selection).
          const connId = ds.connectionId;
          const model = ds.odooModel;
          const modelName = model;
          const fields = (ds.fields || []).slice().sort((a, b) => (a.order || 0) - (b.order || 0)).map((f, idx) => ({
            fieldName: f.fieldName,
            label: f.label || f.fieldName,
            order: idx,
            type: f.type || "",
          }));

          runServer(
            "api_setDraftModel",
            [{ connectionId: connId, model, modelName }],
            (draft1) => {
              applyDraft(draft1);
              runServer(
                "api_setDraftFields",
                [{ connectionId: connId, model, fields }],
                (draft2) => {
                  applyDraft(draft2);
                  setEditingUI(ds);
                  setStatus("ok", "Listo para editar. Cambia lo que quieras y toca Guardar cambios.");
                },
                (e) => {
                  const msg = (e && (e.message || String(e))) || "Error";
                  setStatus("err", "No pude cargar las columnas para editar.", msg);
                }
              );
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude cargar la tabla para editar.", msg);
            }
          );
          return;
        }

        if (action === "refresh") {
          const id = btn.getAttribute("data-id");
          const msgEl = $("ds_item_msg_" + id);
          setMsg(msgEl, "", "");
          btn.disabled = true;
          setStatus("info", "Refrescando...", `Datasource: ${id}`);
          runServer(
            "api_refreshDatasource",
            [id, { automated: false }],
            (res) => {
              setMsg(msgEl, "ok", `OK: ${res.rowsFetched} filas`);
              setStatus("ok", `Refresco OK: ${res.rowsFetched} filas.`);
              btn.disabled = false;
              loadBootstrap();
            },
            (e) => {
              setMsg(msgEl, "err", (e && (e.message || String(e))) || "Error");
              setStatus("err", "Fallo el refresco.", e && (e.message || String(e)));
              btn.disabled = false;
            },
            { timeoutMs: 120000 }
          );
        }

        if (action === "delete") {
          const id = btn.getAttribute("data-id");
          const ok = confirm("Borrar esta extraccion?\n\nEsto solo borra la configuracion. No borra la hoja ni los datos.");
          if (!ok) return;
          btn.disabled = true;
          setStatus("info", "Borrando extraccion...", `Datasource: ${id}`);
          runServer(
            "api_deleteDatasource",
            [{ datasourceId: id }],
            () => {
              setStatus("ok", "Extraccion borrada.");
              btn.disabled = false;
              loadBootstrap();
            },
            (e) => {
              const msg = (e && (e.message || String(e))) || "Error";
              setStatus("err", "No pude borrar la extraccion.", msg);
              btn.disabled = false;
            }
          );
        }
      });

      $("btnClearStatus").addEventListener("click", () => {
        const bar = $("statusBar");
        if (!bar) return;
        bar.className = "status";
        $("statusText").textContent = "";
        $("statusDetail").textContent = "";
      });

      window.addEventListener("error", (ev) => {
        const msg = (ev && ev.message) || "Error de JavaScript en la interfaz.";
        const where = ev && ev.filename ? `${ev.filename}:${ev.lineno || ""}` : "";
        setStatus("err", msg, where);
      });
      window.addEventListener("unhandledrejection", (ev) => {
        const reason = (ev && ev.reason && (ev.reason.message || String(ev.reason))) || "Promise rechazada.";
        setStatus("err", "Error en la interfaz.", reason);
      });

      try {
        $("uiBuild").textContent = UI_BUILD;
      } catch (_) {}

      loadBootstrap();
    </script>
  </body>
</html>
