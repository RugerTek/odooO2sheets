<!doctype html>
<html>
  <head>
    <base target="_top" />
    <style>
      :root {
        --bg: #f8fafc;
        --panel: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --line: rgba(15, 23, 42, 0.12);
        --accent: #16a34a;
        --danger: #dc2626;
        --warn: #d97706;
      }
      html, body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font: 13px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }
      .wrap { padding: 12px; }
      h1 { font-size: 14px; margin: 0 0 10px; }
      h2 { font-size: 12px; margin: 0 0 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
      h3 { font-size: 12px; margin: 12px 0 8px; color: var(--text); }
      .row { display: flex; gap: 8px; align-items: center; }
      .col { flex: 1; }
      .card {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
      }
      label { display: block; color: var(--muted); margin: 6px 0 2px; font-size: 12px; }
      input, select, textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        background: #ffffff;
        border: 1px solid rgba(15, 23, 42, 0.18);
        border-radius: 8px;
        color: var(--text);
        outline: none;
      }
      textarea { resize: vertical; min-height: 68px; }
      input::placeholder, textarea::placeholder { color: rgba(15,23,42,0.35); }
      button {
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      button.primary { border-color: rgba(22,163,74,0.35); background: rgba(22,163,74,0.10); }
      button.danger { border-color: rgba(220,38,38,0.35); background: rgba(220,38,38,0.08); }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .pill { display: inline-flex; gap: 6px; align-items: center; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--line); color: var(--muted); font-size: 12px; }
      .sep { height: 1px; background: var(--line); margin: 10px 0; }
      .msg { margin-top: 8px; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--line); background: rgba(15,23,42,0.02); }
      .msg.ok { border-color: rgba(34,197,94,0.35); }
      .msg.err { border-color: rgba(239,68,68,0.35); }
      .list { display: flex; flex-direction: column; gap: 8px; }
      .item { padding: 8px 10px; border: 1px solid var(--line); border-radius: 10px; background: rgba(15,23,42,0.02); }
      .item .title { font-weight: 600; }
      .item .meta { color: var(--muted); font-size: 12px; margin-top: 2px; }
      .item .actions { margin-top: 8px; display: flex; gap: 8px; }
      .small { font-size: 12px; color: var(--muted); }
      .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
      .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; border: 1px solid var(--line); padding: 1px 6px; border-radius: 7px; background: rgba(15,23,42,0.02); }
      .step { display: inline-flex; align-items: center; gap: 8px; }
      .step .n { width: 20px; height: 20px; border-radius: 999px; border: 1px solid var(--line); display: inline-flex; align-items: center; justify-content: center; color: var(--muted); font-size: 12px; }
      .step .t { font-weight: 600; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Odoo O2Sheets</h1>
      <div class="small" id="ctx"></div>

      <div class="card">
        <h2>Como Probar (sin programacion)</h2>
        <div class="hint">
          1) Crea una Connection (URL + Database).<br />
          2) Hace Login (con tu usuario Odoo).<br />
          3) Busca un modelo, elegi campos y guarda un Datasource.<br />
          4) Apreta <span class="kbd">Refresh</span> para traer datos a la sheet.
        </div>
        <div class="hint" style="margin-top: 8px;">
          Importante: para Odoo Online, el campo <b>Database</b> suele ser el subdominio (ej: <span class="kbd">unika-sa-motor-haus</span>).
        </div>
      </div>

      <div class="card">
        <h2>Connections</h2>
        <div class="row" style="margin-bottom: 8px;">
          <button id="btnTestUrl">Test URL</button>
          <div class="small col" id="urlTestOut"></div>
        </div>
        <div class="list" id="connectionsList"></div>
        <div class="sep"></div>
        <div class="row">
          <div class="pill">New connection</div>
        </div>
        <div class="hint" style="margin-top: 8px;">
          Nota: ya no necesitás completar Name/Title. Solo URL y Database.
        </div>
        <label>Web Address (public)</label>
        <input id="c_url" placeholder="https://your-odoo.example.com" />
        <div class="hint">Ejemplo que pasaste: <span class="kbd">https://unika-sa-motor-haus.odoo.com</span></div>
        <label>Database</label>
        <input id="c_db" placeholder="odoo_db_name" />
        <div class="hint">
          Tip: a veces NO es el subdominio. Si te dice "Database no encontrada", pega abajo el string psql (si lo tenes) y autocompleta.
        </div>
        <label>Autocompletar desde string psql (opcional)</label>
        <textarea id="c_psql" placeholder='psql postgresql://user@host/dbname'></textarea>
        <div class="row">
          <button id="btnFillFromPsql">Autocompletar URL + DB</button>
          <div class="small col" id="psqlOut"></div>
        </div>
        <div class="grid2">
          <div>
            <label><input type="checkbox" id="c_store" /> Store connections</label>
          </div>
          <div>
            <label><input type="checkbox" id="c_share" /> Share credentials</label>
          </div>
        </div>
        <div class="row">
          <button class="primary" id="btnCreateConn">Save connection</button>
          <button id="btnReload">Reload</button>
        </div>
      </div>

      <div class="card">
        <h2>Login (Odoo)</h2>
        <label>Connection</label>
        <select id="login_conn"></select>
        <label>Odoo username</label>
        <input id="login_user" placeholder="user@example.com" />
        <label>Odoo password</label>
        <input id="login_pass" type="password" placeholder="••••••••" />
        <label><input type="checkbox" id="login_remember" /> Remember my credentials (required for scheduler)</label>
        <div class="hint">
          Para probar manualmente, podes dejarlo apagado. Para scheduler automatico, tiene que estar encendido.
        </div>
        <div class="row">
          <button class="primary" id="btnLogin">Test login / Save</button>
        </div>
        <div id="loginMsg"></div>
      </div>

      <div class="card">
        <h2>Datasources</h2>
        <div class="list" id="datasourcesList"></div>
        <div class="sep"></div>
        <div class="pill">New datasource (wizard simple)</div>
        <div class="hint" style="margin-top:6px;">
          Paso 1: Elegi la sheet y la connection. Paso 2: busca el modelo. Paso 3: carga campos y selecciona. Paso 4: guarda.
        </div>
        <div class="grid2" style="margin-top: 8px;">
          <div>
            <label>Sheet</label>
            <select id="ds_sheet"></select>
          </div>
          <div>
            <label>Connection</label>
            <select id="ds_conn"></select>
          </div>
        </div>
        <label>Odoo model</label>
        <input id="ds_model" placeholder="Ej: res.partner" />
        <div class="row" style="margin-top: 8px;">
          <input id="model_query" class="col" placeholder="Search models (e.g. partner, invoice, sale)" />
          <button id="btnSearchModels">Search</button>
        </div>
        <div id="modelResults" class="list" style="margin-top: 8px;"></div>
        <h3 class="step"><span class="n">3</span><span class="t">Campos</span></h3>
        <div class="hint">Podes seleccionar desde la lista o pegar un CSV.</div>
        <label>Fields (CSV)</label>
        <input id="ds_fields" placeholder="id,name,email,phone" />
        <div class="row" style="margin-top: 8px;">
          <button id="btnLoadFields">Load fields</button>
          <div class="small col">Uses Odoo `fields_get` (requires login).</div>
        </div>
        <div id="fieldResults" class="list" style="margin-top: 8px; max-height: 180px; overflow: auto;"></div>
        <div class="sep"></div>
        <h3 class="step"><span class="n">4</span><span class="t">Orden de columnas</span></h3>
        <div class="hint">Selecciona campos y luego ajusta el orden.</div>
        <div id="selectedFields" class="list" style="margin-top: 8px;"></div>
        <div class="grid2">
          <div>
            <label>Limit</label>
            <input id="ds_limit" type="number" value="80" />
          </div>
          <div>
            <label>Order by (optional)</label>
            <input id="ds_order" placeholder="id desc" />
          </div>
        </div>
        <label>Domain (optional JSON array)</label>
        <textarea id="ds_domain" placeholder='[["active","=",true]]'></textarea>
        <div class="grid2">
          <div>
            <label>Write mode</label>
            <select id="ds_mode">
              <option value="REPLACE">REPLACE</option>
              <option value="APPEND">APPEND</option>
            </select>
          </div>
          <div>
            <label><input type="checkbox" id="ds_header" checked /> Write header row</label>
          </div>
        </div>
        <div class="row">
          <button class="primary" id="btnCreateDs">Save datasource</button>
        </div>
        <div id="dsMsg"></div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      let state = { context: null, connections: [], datasources: [] };
      let selectedFields = []; // [{fieldName,label,type}]
      let fieldMeta = {}; // fieldName -> {label,type,relation,help}

      function setMsg(el, kind, text) {
        el.innerHTML = "";
        if (!text) return;
        const d = document.createElement("div");
        d.className = "msg " + (kind === "ok" ? "ok" : "err");
        d.textContent = text;
        el.appendChild(d);
      }

      function loadBootstrap() {
        google.script.run
          .withSuccessHandler((res) => {
            state = res;
            $("ctx").textContent = `Doc: ${res.context.spreadsheetId} | User: ${res.context.userEmail}`;
            render();
            refreshSheets();
          })
          .withFailureHandler((e) => {
            console.error(e);
          })
          .api_getBootstrap();
      }

      function suggestDbFromUrl() {
        const url = $("c_url").value.trim();
        if (!url) return;
        try {
          const u = new URL(url);
          const host = u.hostname || "";
          // Odoo Online typical: <db>.odoo.com
          if (host.endsWith(".odoo.com")) {
            const sub = host.split(".")[0];
            if (sub && !$("c_db").value.trim()) $("c_db").value = sub;
          }
        } catch (_) {}
      }

      function render() {
        const connSelIds = ["login_conn", "ds_conn"];
        connSelIds.forEach((sid) => {
          const sel = $(sid);
          sel.innerHTML = "";
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = "Select...";
          sel.appendChild(opt0);
          state.connections.forEach((c) => {
            const o = document.createElement("option");
            o.value = c.id;
            o.textContent = `${c.title} (${c.name})`;
            sel.appendChild(o);
          });
        });

        const cl = $("connectionsList");
        cl.innerHTML = "";
        if (state.connections.length === 0) {
          const empty = document.createElement("div");
          empty.className = "small";
          empty.textContent = "No connections yet.";
          cl.appendChild(empty);
        } else {
          state.connections.forEach((c) => {
            const it = document.createElement("div");
            it.className = "item";
            it.innerHTML = `
              <div class="title">${escapeHtml(c.title)} <span class="pill">${escapeHtml(c.name)}</span></div>
              <div class="meta">${escapeHtml(c.odooUrl)} | DB: ${escapeHtml(c.odooDb)} | shareCreds=${c.shareCredentials}</div>
            `;
            cl.appendChild(it);
          });
        }

        const dl = $("datasourcesList");
        dl.innerHTML = "";
        if (state.datasources.length === 0) {
          const empty = document.createElement("div");
          empty.className = "small";
          empty.textContent = "No datasources yet.";
          dl.appendChild(empty);
        } else {
          state.datasources.forEach((d) => {
            const it = document.createElement("div");
            it.className = "item";
            const last = d.lastRun ? `${d.lastRun.status} @ ${d.lastRun.at} (${d.lastRun.rows} rows)` : "never";
            const sched = d.schedulerEnabled ? "on" : "off";
            it.innerHTML = `
              <div class="title">${escapeHtml(d.sheetName)} <span class="pill">${escapeHtml(d.odooModel)}</span></div>
              <div class="meta">Fields: ${escapeHtml(d.fields.map(f => f.fieldName).join(","))}</div>
              <div class="meta">Last run: ${escapeHtml(last)} | scheduler: ${sched}</div>
              <div class="actions">
                <button class="primary" data-action="refresh" data-id="${d.id}">Refresh</button>
                <button data-action="schedule" data-id="${d.id}">${d.schedulerEnabled ? "Disable schedule" : "Enable schedule"}</button>
              </div>
              <div id="ds_item_msg_${d.id}"></div>
            `;
            dl.appendChild(it);
          });
        }
      }

      function refreshSheets() {
        google.script.run
          .withSuccessHandler((names) => {
            const sel = $("ds_sheet");
            sel.innerHTML = "";
            names.forEach((n) => {
              const o = document.createElement("option");
              o.value = n;
              o.textContent = n;
              sel.appendChild(o);
            });
          })
          .api_listSheets();
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      $("btnReload").addEventListener("click", loadBootstrap);
      $("c_url").addEventListener("blur", suggestDbFromUrl);

      function fillFromPsql() {
        const raw = ($("c_psql").value || "").trim();
        $("psqlOut").textContent = "";
        if (!raw) return;
        // Accept: "psql postgresql://user:pass@host:port/dbname" or just the URL part.
        const m = raw.match(/postgres(?:ql)?:\\/\\/[^@]+@([^\\/\\s]+)\\/([^\\s?#]+)/i);
        if (!m) {
          $("psqlOut").textContent = "No pude leerlo. Debe contener postgresql://...@HOST/DB";
          return;
        }
        const host = m[1];
        const db = m[2];
        $("c_url").value = `https://${host}`;
        $("c_db").value = db;
        $("psqlOut").textContent = "Listo. Ahora guarda la connection.";
      }

      $("btnFillFromPsql").addEventListener("click", fillFromPsql);

      $("btnTestUrl").addEventListener("click", () => {
        const url = $("c_url").value || (state.connections[0] && state.connections[0].odooUrl) || "";
        if (!url) {
          $("urlTestOut").textContent = "Pega la URL de Odoo primero.";
          return;
        }
        $("urlTestOut").textContent = "Probando...";
        google.script.run
          .withSuccessHandler((res) => {
            const checks = (res.checks || []).map((c) => `${c.code}`).join(", ");
            const v = res && res.version;
            const vTxt = v ? ` | version: ${JSON.stringify(v)}` : "";
            $("urlTestOut").textContent = `OK${vTxt}${checks ? " | codes: " + checks : ""}`;
          })
          .withFailureHandler((e) => {
            $("urlTestOut").textContent =
              "Error: " +
              (e.message || String(e)) +
              " (verifica que la URL termine en .odoo.com y no tenga espacios)";
          })
          .api_testOdooUrl({ odooUrl: url });
      });

      $("btnCreateConn").addEventListener("click", () => {
        setMsg($("dsMsg"), "", "");
        google.script.run
          .withSuccessHandler((conn) => {
            setMsg($("loginMsg"), "ok", "Connection saved. Ahora hace Login.");
            loadBootstrap();
            setTimeout(() => {
              try {
                $("login_conn").value = conn.id;
                $("ds_conn").value = conn.id;
              } catch (_) {}
            }, 200);
          })
          .withFailureHandler((e) => setMsg($("loginMsg"), "err", e.message || String(e)))
          .api_createConnection({
            odooUrl: $("c_url").value,
            odooDb: $("c_db").value,
            storeConnections: $("c_store").checked,
            shareCredentials: $("c_share").checked,
          });
      });

      $("btnLogin").addEventListener("click", () => {
        setMsg($("loginMsg"), "", "");
        const connId = $("login_conn").value;
        if (!connId) {
          setMsg($("loginMsg"), "err", "Primero selecciona una Connection (o crea una y guardala).");
          return;
        }
        google.script.run
          .withSuccessHandler((res) => {
            setMsg($("loginMsg"), "ok", `Login OK (uid=${res.uid}). Advanced=${res.canUseAdvanced}`);
            loadBootstrap();
          })
          .withFailureHandler((e) => setMsg($("loginMsg"), "err", e.message || String(e)))
          .api_setCredential({
            connectionId: connId,
            odooUsername: $("login_user").value,
            odooPassword: $("login_pass").value,
            remember: $("login_remember").checked,
          });
      });

      $("btnCreateDs").addEventListener("click", () => {
        setMsg($("dsMsg"), "", "");
        if (!$("ds_conn").value) {
          setMsg($("dsMsg"), "err", "Selecciona una Connection.");
          return;
        }
        if (!$("ds_sheet").value) {
          setMsg($("dsMsg"), "err", "Selecciona una Sheet.");
          return;
        }
        if (!$("ds_model").value) {
          setMsg($("dsMsg"), "err", "Selecciona un modelo (Search + Use model).");
          return;
        }
        const fieldArr =
          selectedFields.length > 0
            ? selectedFields.map((f, idx) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, order: idx }))
            : [];
        google.script.run
          .withSuccessHandler((ds) => {
            setMsg($("dsMsg"), "ok", `Datasource saved: ${ds.id}`);
            loadBootstrap();
          })
          .withFailureHandler((e) => setMsg($("dsMsg"), "err", e.message || String(e)))
          .api_createDatasource({
            sheetName: $("ds_sheet").value,
            connectionId: $("ds_conn").value,
            odooModel: $("ds_model").value,
            fieldsCsv: $("ds_fields").value,
            fields: fieldArr,
            limit: Number($("ds_limit").value || 80),
            domain: $("ds_domain").value,
            orderBy: $("ds_order").value,
            writeMode: $("ds_mode").value,
            header: $("ds_header").checked,
          });
      });

      function renderModelResults(items) {
        const root = $("modelResults");
        root.innerHTML = "";
        if (!items || items.length === 0) {
          const d = document.createElement("div");
          d.className = "small";
          d.textContent = "No results.";
          root.appendChild(d);
          return;
        }
        items.forEach((m) => {
          const it = document.createElement("div");
          it.className = "item";
          const mod = m.modules ? ` | modules: ${m.modules}` : "";
          it.innerHTML = `
            <div class="title">${escapeHtml(m.model)} <span class="pill">${escapeHtml(m.name || "")}</span></div>
            <div class="meta">${escapeHtml(mod)}</div>
            <div class="actions"><button class="primary" data-action="pickModel" data-model="${escapeHtml(m.model)}">Use model</button></div>
          `;
          root.appendChild(it);
        });
      }

      $("btnSearchModels").addEventListener("click", () => {
        const connId = $("ds_conn").value || $("login_conn").value;
        const q = $("model_query").value;
        if (!connId) {
          setMsg($("dsMsg"), "err", "Primero selecciona una Connection y hace Login.");
          return;
        }
        $("modelResults").innerHTML = `<div class="small">Searching...</div>`;
        google.script.run
          .withSuccessHandler((items) => renderModelResults(items))
          .withFailureHandler((e) => setMsg($("dsMsg"), "err", e.message || String(e)))
          .api_searchModels({ connectionId: connId, query: q, limit: 20 });
      });

      function renderFieldResults(fields) {
        const root = $("fieldResults");
        root.innerHTML = "";
        if (!fields || fields.length === 0) {
          const d = document.createElement("div");
          d.className = "small";
          d.textContent = "No fields (or not allowed).";
          root.appendChild(d);
          return;
        }

        fieldMeta = {};
        fields.forEach((f) => {
          fieldMeta[f.fieldName] = f;
        });

        const current = new Set(
          $("ds_fields")
            .value.split(",")
            .map((s) => s.trim())
            .filter(Boolean)
        );

        fields.forEach((f) => {
          const it = document.createElement("div");
          it.className = "item";
          const rel = f.relation ? ` -> ${f.relation}` : "";
          const checked = current.has(f.fieldName) ? "checked" : "";
          it.innerHTML = `
            <label style="margin:0;">
              <input type="checkbox" data-action="toggleField" data-field="${escapeHtml(f.fieldName)}" ${checked} />
              <span class="title">${escapeHtml(f.fieldName)}</span>
              <span class="pill">${escapeHtml(f.type)}${escapeHtml(rel)}</span>
            </label>
            <div class="meta">${escapeHtml(f.label || "")}</div>
          `;
          root.appendChild(it);
        });
      }

      function syncSelectedFieldsFromCsvIfEmpty() {
        if (selectedFields.length > 0) return;
        const csv = $("ds_fields")
          .value.split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        selectedFields = csv.map((name) => {
          const meta = fieldMeta[name] || {};
          return { fieldName: name, label: meta.label || name, type: meta.type || "" };
        });
      }

      function renderSelectedFields() {
        const root = $("selectedFields");
        root.innerHTML = "";
        if (selectedFields.length === 0) {
          const d = document.createElement("div");
          d.className = "small";
          d.textContent = "Selecciona campos (Load fields) o pega un CSV.";
          root.appendChild(d);
          return;
        }
        selectedFields.forEach((f, idx) => {
          const it = document.createElement("div");
          it.className = "item";
          it.innerHTML = `
            <div class="row">
              <div class="col">
                <div class="title">${escapeHtml(f.fieldName)}</div>
                <div class="meta">${escapeHtml(f.label || "")}</div>
              </div>
              <div class="row">
                <button data-action="moveFieldUp" data-idx="${idx}">Up</button>
                <button data-action="moveFieldDown" data-idx="${idx}">Down</button>
                <button class="danger" data-action="removeField" data-idx="${idx}">Remove</button>
              </div>
            </div>
          `;
          root.appendChild(it);
        });
      }

      $("btnLoadFields").addEventListener("click", () => {
        const connId = $("ds_conn").value || $("login_conn").value;
        const model = $("ds_model").value;
        if (!connId) {
          setMsg($("dsMsg"), "err", "Select a connection first.");
          return;
        }
        if (!model) {
          setMsg($("dsMsg"), "err", "Set a model first (or search and pick one).");
          return;
        }
        $("fieldResults").innerHTML = `<div class="small">Loading fields...</div>`;
        google.script.run
          .withSuccessHandler((items) => {
            renderFieldResults(items);
            // keep selection in sync with CSV if user already typed it
            selectedFields = [];
            syncSelectedFieldsFromCsvIfEmpty();
            renderSelectedFields();
          })
          .withFailureHandler((e) => setMsg($("dsMsg"), "err", e.message || String(e)))
          .api_getModelFields({ connectionId: connId, model });
      });

      document.body.addEventListener("click", (ev) => {
        const btn = ev.target && ev.target.closest && ev.target.closest("button[data-action]");
        const cb =
          ev.target && ev.target.closest && ev.target.closest("input[type=checkbox][data-action]");
        const action = btn ? btn.getAttribute("data-action") : cb ? cb.getAttribute("data-action") : null;
        if (!action) return;

        if (action === "toggleField") {
          const field = cb.getAttribute("data-field");
          const existing = $("ds_fields")
            .value.split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          const set = new Set(existing);
          if (cb.checked) set.add(field);
          else set.delete(field);
          $("ds_fields").value = Array.from(set).join(",");

          // Maintain selectedFields ordered by selection time.
          if (cb.checked) {
            const meta = fieldMeta[field] || {};
            if (!selectedFields.some((x) => x.fieldName === field)) {
              selectedFields.push({ fieldName: field, label: meta.label || field, type: meta.type || "" });
            }
          } else {
            selectedFields = selectedFields.filter((x) => x.fieldName !== field);
          }
          renderSelectedFields();
          return;
        }

        if (action === "pickModel") {
          const model = btn.getAttribute("data-model");
          $("ds_model").value = model;
          // Auto-load fields after picking.
          $("btnLoadFields").click();
          return;
        }

        if (action === "moveFieldUp" || action === "moveFieldDown" || action === "removeField") {
          const idx = Number(btn.getAttribute("data-idx"));
          if (!Number.isFinite(idx)) return;
          if (action === "removeField") {
            selectedFields.splice(idx, 1);
          } else if (action === "moveFieldUp" && idx > 0) {
            const t = selectedFields[idx - 1];
            selectedFields[idx - 1] = selectedFields[idx];
            selectedFields[idx] = t;
          } else if (action === "moveFieldDown" && idx < selectedFields.length - 1) {
            const t = selectedFields[idx + 1];
            selectedFields[idx + 1] = selectedFields[idx];
            selectedFields[idx] = t;
          }
          $("ds_fields").value = selectedFields.map((x) => x.fieldName).join(",");
          renderSelectedFields();
          return;
        }

        if (!btn) return;

        const id = btn.getAttribute("data-id");
        const msgEl = $("ds_item_msg_" + id);
        setMsg(msgEl, "", "");

        if (action === "refresh") {
          btn.disabled = true;
          google.script.run
            .withSuccessHandler((res) => {
              setMsg(msgEl, "ok", `OK: ${res.rowsFetched} rows`);
              loadBootstrap();
            })
            .withFailureHandler((e) => setMsg(msgEl, "err", e.message || String(e)))
            .api_refreshDatasource(id, { automated: false });
          setTimeout(() => (btn.disabled = false), 2000);
          return;
        }

        if (action === "schedule") {
          // Minimal scheduler: enable with default (weekdays=Mon-Fri, hours=6,12,18) for now.
          const enable = btn.textContent.includes("Enable");
          const cfg = enable
            ? {
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "Etc/UTC",
                hours: [6, 12, 18],
                daysOfMonth: [],
                weekdays: [1, 2, 3, 4, 5],
                months: [],
              }
            : undefined;
          google.script.run
            .withSuccessHandler(() => {
              setMsg(msgEl, "ok", enable ? "Scheduler enabled (basic default)." : "Scheduler disabled.");
              loadBootstrap();
            })
            .withFailureHandler((e) => setMsg(msgEl, "err", e.message || String(e)))
            .api_setDatasourceSchedule({ datasourceId: id, enabled: enable, config: cfg });
        }
      });

      loadBootstrap();
    </script>
  </body>
</html>
