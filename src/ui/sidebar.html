<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <style>
      :root {
        --bg: #f8fafc;
        --panel: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --line: rgba(15, 23, 42, 0.12);
        --accent: #16a34a;
        --danger: #dc2626;
      }
      html, body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font: 13px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      .wrap { padding: 12px; }
      h1 { font-size: 14px; margin: 0 0 8px; }
      h2 { font-size: 12px; margin: 0 0 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
      h3 { font-size: 12px; margin: 12px 0 8px; }

      .card {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .row { display: flex; gap: 8px; align-items: center; }
      .col { flex: 1; }
      .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .sep { height: 1px; background: var(--line); margin: 10px 0; }

      label { display: block; color: var(--muted); margin: 6px 0 2px; font-size: 12px; }
      input, select, textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        background: #fff;
        border: 1px solid rgba(15, 23, 42, 0.18);
        border-radius: 8px;
        color: var(--text);
        outline: none;
      }
      textarea { resize: vertical; min-height: 64px; }
      input::placeholder, textarea::placeholder { color: rgba(15,23,42,0.35); }

      button {
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      button.primary { border-color: rgba(22,163,74,0.35); background: rgba(22,163,74,0.10); }
      button.danger { border-color: rgba(220,38,38,0.35); background: rgba(220,38,38,0.08); }
      button:disabled { opacity: 0.55; cursor: not-allowed; }

      .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
      .msg { margin-top: 8px; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--line); background: rgba(15,23,42,0.02); }
      .msg.ok { border-color: rgba(22,163,74,0.35); }
      .msg.err { border-color: rgba(220,38,38,0.35); }

      .list { display: flex; flex-direction: column; gap: 8px; }
      .item { padding: 8px 10px; border: 1px solid var(--line); border-radius: 10px; background: rgba(15,23,42,0.02); }
      .title { font-weight: 600; }
      .meta { color: var(--muted); font-size: 12px; margin-top: 2px; }
      .pill { display: inline-flex; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--line); color: var(--muted); font-size: 12px; }
      .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; border: 1px solid var(--line); padding: 1px 6px; border-radius: 7px; background: rgba(15,23,42,0.02); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Odoo O2Sheets</h1>
      <div class="hint" id="ctx"></div>

      <div class="card">
        <h2>Guia Rapida</h2>
        <div class="hint">
          1) Crea una conexion (URL + Database).<br />
          2) Hace login.<br />
          3) Crea una extraccion: elegi modelo y campos, guarda, y luego <span class="kbd">Refresh</span>.
        </div>
      </div>

      <div class="card">
        <h2>1) Conexion</h2>
        <label>Odoo URL (publica)</label>
        <input id="c_url" placeholder="https://xxxxx.odoo.com o https://xxxxx.dev.odoo.com" />
        <label>Database (nombre exacto)</label>
        <input id="c_db" placeholder="ej: unika-sa-motor-haus1-main-25276166" />

        <div class="row" style="margin-top: 8px;">
          <button id="btnTestUrl">Probar URL</button>
          <button class="primary" id="btnCreateConn">Guardar conexion</button>
          <button id="btnReload">Recargar</button>
        </div>
        <div id="connMsg"></div>

        <div class="sep"></div>
        <div class="hint">Conexiones guardadas en esta planilla:</div>
        <div class="list" id="connectionsList"></div>
      </div>

      <div class="card">
        <h2>2) Login</h2>
        <label>Conexion</label>
        <select id="login_conn"></select>
        <label>Usuario Odoo</label>
        <input id="login_user" placeholder="ej: admin o tu-email@empresa.com" />
        <label>Password Odoo</label>
        <input id="login_pass" type="password" placeholder="password" />
        <label><input type="checkbox" id="login_remember" /> Recordar credenciales (solo si queres scheduler)</label>
        <div class="row" style="margin-top: 8px;">
          <button class="primary" id="btnLogin">Probar login</button>
        </div>
        <div id="loginMsg"></div>
      </div>

      <div class="card">
        <h2>3) Crear Extraccion</h2>
        <div class="grid2">
          <div>
            <label>Hoja destino</label>
            <select id="ds_sheet"></select>
          </div>
          <div>
            <label>Conexion</label>
            <select id="ds_conn"></select>
          </div>
        </div>

        <h3>Modelo</h3>
        <label>Modelo Odoo (tecnico)</label>
        <input id="ds_model" placeholder="ej: res.partner" />
        <div class="row" style="margin-top: 8px;">
          <input id="model_query" class="col" placeholder="Buscar modelo (ej: partner, invoice, sale)" />
          <button id="btnSearchModels">Buscar</button>
        </div>
        <div id="modelResults" class="list" style="margin-top: 8px;"></div>

        <h3>Campos</h3>
        <div class="row" style="margin-top: 8px;">
          <button id="btnLoadFields">Cargar campos del modelo</button>
          <div class="hint col">Luego marcarlos y reordenarlos abajo.</div>
        </div>
        <div class="row" style="margin-top: 8px;">
          <input id="field_query" class="col" placeholder="Filtrar campos (ej: name, email, phone)" />
          <button id="btnClearFieldFilter">Limpiar</button>
        </div>
        <div id="fieldResults" class="list" style="margin-top: 8px; max-height: 180px; overflow: auto;"></div>

        <h3>Columnas (seleccionadas)</h3>
        <div class="hint">Aca podes cambiar el orden y el encabezado en la hoja.</div>
        <div id="selectedFields" class="list" style="margin-top: 8px;"></div>

        <div class="sep"></div>
        <div class="grid2">
          <div>
            <label>Limite</label>
            <input id="ds_limit" type="number" value="80" />
          </div>
          <div>
            <label>Orden (opcional)</label>
            <input id="ds_order" placeholder="id desc" />
          </div>
        </div>
        <label>Filtro (Domain) opcional (JSON)</label>
        <textarea id="ds_domain" placeholder='[["active","=",true]]'></textarea>
        <div class="grid2">
          <div>
            <label>Modo de escritura</label>
            <select id="ds_mode">
              <option value="REPLACE">REPLACE</option>
              <option value="APPEND">APPEND</option>
            </select>
          </div>
          <div>
            <label><input type="checkbox" id="ds_header" checked /> Escribir encabezados</label>
          </div>
        </div>
        <div class="row" style="margin-top: 8px;">
          <button class="primary" id="btnCreateDs">Guardar extraccion</button>
        </div>
        <div id="dsMsg"></div>
      </div>

      <div class="card">
        <h2>Mis Extracciones</h2>
        <div class="list" id="datasourcesList"></div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      let state = { context: null, connections: [], datasources: [] };
      let selectedFields = []; // [{fieldName,label,type}]
      let fieldMeta = {}; // fieldName -> meta
      let allFields = [];

      function setMsg(el, kind, text) {
        el.innerHTML = "";
        if (!text) return;
        const d = document.createElement("div");
        d.className = "msg " + (kind === "ok" ? "ok" : "err");
        d.textContent = text;
        el.appendChild(d);
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function loadBootstrap() {
        google.script.run
          .withSuccessHandler((res) => {
            state = res;
            $("ctx").textContent = `Doc: ${res.context.spreadsheetId} | Usuario Google: ${res.context.userEmail}`;
            render();
            refreshSheets();
          })
          .withFailureHandler((e) => {
            setMsg($("connMsg"), "err", e.message || String(e));
          })
          .api_getBootstrap();
      }

      function render() {
        // Connections list
        const cl = $("connectionsList");
        cl.innerHTML = "";
        if (!state.connections.length) {
          const d = document.createElement("div");
          d.className = "hint";
          d.textContent = "No hay conexiones todavia.";
          cl.appendChild(d);
        } else {
          state.connections.forEach((c) => {
            const it = document.createElement("div");
            it.className = "item";
            it.innerHTML = `
              <div class="title">${escapeHtml(c.title || c.name)}</div>
              <div class="meta">${escapeHtml(c.odooUrl)} | DB: ${escapeHtml(c.odooDb)}</div>
            `;
            cl.appendChild(it);
          });
        }

        // Connection selects
        const prevLogin = $("login_conn").value;
        const prevDs = $("ds_conn").value;
        for (const sid of ["login_conn", "ds_conn"]) {
          const sel = $(sid);
          sel.innerHTML = "";
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = "Seleccionar...";
          sel.appendChild(opt0);
          state.connections.forEach((c) => {
            const o = document.createElement("option");
            o.value = c.id;
            o.textContent = c.title || c.name;
            sel.appendChild(o);
          });
        }
        if (prevLogin) $("login_conn").value = prevLogin;
        if (prevDs) $("ds_conn").value = prevDs;
        if (!prevLogin && state.connections.length === 1) $("login_conn").value = state.connections[0].id;
        if (!prevDs && state.connections.length === 1) $("ds_conn").value = state.connections[0].id;

        // Datasources list
        const dl = $("datasourcesList");
        dl.innerHTML = "";
        if (!state.datasources.length) {
          const d = document.createElement("div");
          d.className = "hint";
          d.textContent = "No hay extracciones todavia.";
          dl.appendChild(d);
        } else {
          state.datasources.forEach((ds) => {
            const it = document.createElement("div");
            it.className = "item";
            const last = ds.lastRun ? `${ds.lastRun.status} @ ${ds.lastRun.at} (${ds.lastRun.rows} filas)` : "nunca";
            it.innerHTML = `
              <div class="title">${escapeHtml(ds.sheetName)} <span class="pill">${escapeHtml(ds.odooModel)}</span></div>
              <div class="meta">Campos: ${escapeHtml(ds.fields.map((f) => f.fieldName).join(", "))}</div>
              <div class="meta">Ultima ejecucion: ${escapeHtml(last)}</div>
              <div class="row" style="margin-top:8px;">
                <button class="primary" data-action="refresh" data-id="${ds.id}">Refresh</button>
              </div>
              <div id="ds_item_msg_${ds.id}"></div>
            `;
            dl.appendChild(it);
          });
        }
      }

      function refreshSheets() {
        google.script.run
          .withSuccessHandler((names) => {
            const sel = $("ds_sheet");
            sel.innerHTML = "";
            names.forEach((n) => {
              const o = document.createElement("option");
              o.value = n;
              o.textContent = n;
              sel.appendChild(o);
            });
          })
          .withFailureHandler((e) => setMsg($("dsMsg"), "err", e.message || String(e)))
          .api_listSheets();
      }

      function suggestDbFromUrl() {
        const url = ($("c_url").value || "").trim();
        if (!url) return;
        try {
          const u = new URL(url.replace(/\\/+$/, ""));
          const host = u.hostname || "";
          if (host.endsWith(".odoo.com")) {
            const sub = host.split(".")[0];
            if (sub && !$("c_db").value.trim()) $("c_db").value = sub;
          }
        } catch (_) {}
      }

      $("c_url").addEventListener("blur", suggestDbFromUrl);

      $("btnReload").addEventListener("click", loadBootstrap);

      $("btnTestUrl").addEventListener("click", () => {
        setMsg($("connMsg"), "", "");
        const url = ($("c_url").value || "").trim();
        if (!url) return setMsg($("connMsg"), "err", "PegÃ¡ la URL primero.");
        $("btnTestUrl").disabled = true;
        google.script.run
          .withSuccessHandler(() => {
            setMsg($("connMsg"), "ok", "URL OK (es accesible).");
            $("btnTestUrl").disabled = false;
          })
          .withFailureHandler((e) => {
            setMsg($("connMsg"), "err", e.message || String(e));
            $("btnTestUrl").disabled = false;
          })
          .api_testOdooUrl({ odooUrl: url });
      });

      $("btnCreateConn").addEventListener("click", () => {
        setMsg($("connMsg"), "", "");
        const url = ($("c_url").value || "").trim();
        const db = ($("c_db").value || "").trim();
        if (!url) return setMsg($("connMsg"), "err", "Falta la URL.");
        if (!db) return setMsg($("connMsg"), "err", "Falta el Database.");
        $("btnCreateConn").disabled = true;
        google.script.run
          .withSuccessHandler((conn) => {
            setMsg($("connMsg"), "ok", "Conexion guardada. Ahora hace login.");
            loadBootstrap();
            setTimeout(() => {
              try {
                $("login_conn").value = conn.id;
                $("ds_conn").value = conn.id;
              } catch (_) {}
            }, 200);
            $("btnCreateConn").disabled = false;
          })
          .withFailureHandler((e) => {
            setMsg($("connMsg"), "err", e.message || String(e));
            $("btnCreateConn").disabled = false;
          })
          .api_createConnection({ odooUrl: url, odooDb: db, storeConnections: false, shareCredentials: false });
      });

      $("btnLogin").addEventListener("click", () => {
        setMsg($("loginMsg"), "", "");
        const connId = $("login_conn").value;
        if (!connId) return setMsg($("loginMsg"), "err", "Selecciona una conexion.");
        $("btnLogin").disabled = true;
        google.script.run
          .withSuccessHandler((res) => {
            setMsg($("loginMsg"), "ok", `Login OK (uid=${res.uid}).`);
            $("btnLogin").disabled = false;
            loadBootstrap();
          })
          .withFailureHandler((e) => {
            setMsg($("loginMsg"), "err", e.message || String(e));
            $("btnLogin").disabled = false;
          })
          .api_setCredential({
            connectionId: connId,
            odooUsername: $("login_user").value,
            odooPassword: $("login_pass").value,
            remember: $("login_remember").checked,
          });
      });

      function renderModelResults(items) {
        const root = $("modelResults");
        root.innerHTML = "";
        if (!items || items.length === 0) {
          const d = document.createElement("div");
          d.className = "hint";
          d.textContent = "Sin resultados.";
          root.appendChild(d);
          return;
        }
        items.forEach((m) => {
          const it = document.createElement("div");
          it.className = "item";
          it.innerHTML = `
            <div class="title">${escapeHtml(m.model)} <span class="pill">${escapeHtml(m.name || "")}</span></div>
            <div class="row" style="margin-top:8px;">
              <button class="primary" data-action="pickModel" data-model="${escapeHtml(m.model)}">Usar este modelo</button>
            </div>
          `;
          root.appendChild(it);
        });
      }

      $("btnSearchModels").addEventListener("click", () => {
        setMsg($("dsMsg"), "", "");
        const connId = $("ds_conn").value || $("login_conn").value;
        if (!connId) return setMsg($("dsMsg"), "err", "Selecciona conexion y hace login.");
        const q = ($("model_query").value || "").trim();
        if (!q) return setMsg($("dsMsg"), "err", "Escribi algo para buscar el modelo.");
        $("modelResults").innerHTML = `<div class="hint">Buscando...</div>`;
        google.script.run
          .withSuccessHandler((items) => renderModelResults(items))
          .withFailureHandler((e) => setMsg($("dsMsg"), "err", e.message || String(e)))
          .api_searchModels({ connectionId: connId, query: q, limit: 20 });
      });

      function renderFieldResults(fields) {
        const root = $("fieldResults");
        root.innerHTML = "";
        if (!fields || fields.length === 0) {
          const d = document.createElement("div");
          d.className = "hint";
          d.textContent = "No pude cargar campos (revisa login y modelo).";
          root.appendChild(d);
          return;
        }
        allFields = fields;
        fieldMeta = {};
        fields.forEach((f) => (fieldMeta[f.fieldName] = f));

        const q = ($("field_query").value || "").trim().toLowerCase();
        const filtered = q
          ? fields.filter((f) => String(f.fieldName).toLowerCase().includes(q) || String(f.label).toLowerCase().includes(q))
          : fields;

        const current = new Set(selectedFields.map((x) => x.fieldName));

        filtered.forEach((f) => {
          const it = document.createElement("div");
          it.className = "item";
          const checked = current.has(f.fieldName) ? "checked" : "";
          it.innerHTML = `
            <label style="margin:0;">
              <input type="checkbox" data-action="toggleField" data-field="${escapeHtml(f.fieldName)}" ${checked} />
              <span class="title">${escapeHtml(f.fieldName)}</span>
              <span class="pill">${escapeHtml(f.type)}</span>
            </label>
            <div class="meta">${escapeHtml(f.label || "")}</div>
          `;
          root.appendChild(it);
        });
      }

      function renderSelectedFields() {
        const root = $("selectedFields");
        root.innerHTML = "";
        if (!selectedFields.length) {
          const d = document.createElement("div");
          d.className = "hint";
          d.textContent = "Selecciona campos arriba (checkbox).";
          root.appendChild(d);
          return;
        }
        selectedFields.forEach((f, idx) => {
          const it = document.createElement("div");
          it.className = "item";
          it.innerHTML = `
            <div class="row">
              <div class="col">
                <div class="title">${escapeHtml(f.fieldName)}</div>
                <label>Encabezado</label>
                <input data-action="setLabel" data-idx="${idx}" value="${escapeHtml(f.label || f.fieldName)}" />
              </div>
              <div class="row">
                <button data-action="moveFieldUp" data-idx="${idx}">Up</button>
                <button data-action="moveFieldDown" data-idx="${idx}">Down</button>
                <button class="danger" data-action="removeField" data-idx="${idx}">Remove</button>
              </div>
            </div>
          `;
          root.appendChild(it);
        });
      }

      $("btnLoadFields").addEventListener("click", () => {
        setMsg($("dsMsg"), "", "");
        const connId = $("ds_conn").value || $("login_conn").value;
        const model = ($("ds_model").value || "").trim();
        if (!connId) return setMsg($("dsMsg"), "err", "Selecciona conexion y hace login.");
        if (!model) return setMsg($("dsMsg"), "err", "Primero selecciona un modelo.");
        $("fieldResults").innerHTML = `<div class="hint">Cargando campos...</div>`;
        google.script.run
          .withSuccessHandler((items) => {
            // reset selections only if model changed
            selectedFields = [];
            renderFieldResults(items);
            renderSelectedFields();
          })
          .withFailureHandler((e) => setMsg($("dsMsg"), "err", e.message || String(e)))
          .api_getModelFields({ connectionId: connId, model });
      });

      $("field_query").addEventListener("input", () => {
        if (allFields.length) renderFieldResults(allFields);
      });
      $("btnClearFieldFilter").addEventListener("click", () => {
        $("field_query").value = "";
        if (allFields.length) renderFieldResults(allFields);
      });

      $("btnCreateDs").addEventListener("click", () => {
        setMsg($("dsMsg"), "", "");
        const connId = $("ds_conn").value;
        const sheet = $("ds_sheet").value;
        const model = ($("ds_model").value || "").trim();
        if (!connId) return setMsg($("dsMsg"), "err", "Selecciona conexion.");
        if (!sheet) return setMsg($("dsMsg"), "err", "Selecciona hoja.");
        if (!model) return setMsg($("dsMsg"), "err", "Selecciona modelo.");
        if (!selectedFields.length) return setMsg($("dsMsg"), "err", "Selecciona al menos 1 campo.");

        const fieldArr = selectedFields.map((f, idx) => ({ fieldName: f.fieldName, label: f.label || f.fieldName, order: idx }));
        $("btnCreateDs").disabled = true;
        google.script.run
          .withSuccessHandler((ds) => {
            setMsg($("dsMsg"), "ok", "Extraccion guardada. Ahora podes apretar Refresh en la lista de abajo.");
            $("btnCreateDs").disabled = false;
            loadBootstrap();
          })
          .withFailureHandler((e) => {
            setMsg($("dsMsg"), "err", e.message || String(e));
            $("btnCreateDs").disabled = false;
          })
          .api_createDatasource({
            sheetName: sheet,
            connectionId: connId,
            odooModel: model,
            fields: fieldArr,
            limit: Number($("ds_limit").value || 80),
            domain: $("ds_domain").value,
            orderBy: $("ds_order").value,
            writeMode: $("ds_mode").value,
            header: $("ds_header").checked,
          });
      });

      document.body.addEventListener("click", (ev) => {
        const btn = ev.target && ev.target.closest && ev.target.closest("button[data-action]");
        const cb = ev.target && ev.target.closest && ev.target.closest("input[type=checkbox][data-action]");
        const action = btn ? btn.getAttribute("data-action") : cb ? cb.getAttribute("data-action") : null;
        if (!action) return;

        if (action === "pickModel") {
          const model = btn.getAttribute("data-model");
          $("ds_model").value = model;
          $("modelResults").innerHTML = "";
          // Auto-load fields.
          $("btnLoadFields").click();
          return;
        }

        if (action === "toggleField") {
          const field = cb.getAttribute("data-field");
          if (cb.checked) {
            if (!selectedFields.some((x) => x.fieldName === field)) {
              const meta = fieldMeta[field] || {};
              selectedFields.push({ fieldName: field, label: meta.label || field, type: meta.type || "" });
            }
          } else {
            selectedFields = selectedFields.filter((x) => x.fieldName !== field);
          }
          renderSelectedFields();
          return;
        }

        if (action === "moveFieldUp" || action === "moveFieldDown" || action === "removeField") {
          const idx = Number(btn.getAttribute("data-idx"));
          if (!Number.isFinite(idx) || !selectedFields[idx]) return;
          if (action === "removeField") selectedFields.splice(idx, 1);
          if (action === "moveFieldUp" && idx > 0) {
            const t = selectedFields[idx - 1];
            selectedFields[idx - 1] = selectedFields[idx];
            selectedFields[idx] = t;
          }
          if (action === "moveFieldDown" && idx < selectedFields.length - 1) {
            const t = selectedFields[idx + 1];
            selectedFields[idx + 1] = selectedFields[idx];
            selectedFields[idx] = t;
          }
          renderSelectedFields();
          return;
        }

        if (action === "refresh") {
          const id = btn.getAttribute("data-id");
          const msgEl = $("ds_item_msg_" + id);
          setMsg(msgEl, "", "");
          btn.disabled = true;
          google.script.run
            .withSuccessHandler((res) => {
              setMsg(msgEl, "ok", `OK: ${res.rowsFetched} filas`);
              btn.disabled = false;
              loadBootstrap();
            })
            .withFailureHandler((e) => {
              setMsg(msgEl, "err", e.message || String(e));
              btn.disabled = false;
            })
            .api_refreshDatasource(id, { automated: false });
        }
      });

      document.body.addEventListener("input", (ev) => {
        const inp = ev.target && ev.target.closest && ev.target.closest("input[data-action]");
        if (!inp) return;
        const action = inp.getAttribute("data-action");
        if (action !== "setLabel") return;
        const idx = Number(inp.getAttribute("data-idx"));
        if (!Number.isFinite(idx) || !selectedFields[idx]) return;
        selectedFields[idx].label = inp.value;
      });

      loadBootstrap();
    </script>
  </body>
</html>

