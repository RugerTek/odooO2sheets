<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <style>
      :root {
        --bg: #ffffff;
        --panel: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --line: rgba(15, 23, 42, 0.12);
        --accent: #16a34a;
        --danger: #dc2626;
        --info: #2563eb;
      }
      html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      .wrap { padding: 14px; }
      .top { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
      h1 { font-size: 16px; margin: 0; }
      .muted { color: var(--muted); font-size: 12px; margin-top: 2px; }
      .row { display: flex; gap: 8px; align-items: center; }
      .col { flex: 1; }
      .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start; }
      .panel { border: 1px solid var(--line); border-radius: 12px; padding: 10px; background: rgba(15,23,42,0.01); }
      .panelTitle { font-weight: 700; margin: 0 0 8px; }
      .scroll { max-height: 360px; overflow: auto; padding-right: 4px; }
      input, select, textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid rgba(15, 23, 42, 0.18); border-radius: 10px; }
      textarea { min-height: 90px; }
      button { border: 1px solid rgba(15, 23, 42, 0.14); background: rgba(15, 23, 42, 0.04); color: var(--text); padding: 10px 12px; border-radius: 10px; cursor: pointer; }
      button.primary { border-color: rgba(22,163,74,0.35); background: rgba(22,163,74,0.10); }
      button.danger { border-color: rgba(220,38,38,0.35); background: rgba(220,38,38,0.08); }
      button:disabled { opacity: 0.55; cursor: not-allowed; }
      .msg { margin-top: 10px; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--line); background: rgba(15,23,42,0.02); }
      .msg.ok { border-color: rgba(22,163,74,0.35); }
      .msg.err { border-color: rgba(220,38,38,0.35); }
      .list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
      .item { padding: 10px 12px; border: 1px solid var(--line); border-radius: 12px; background: rgba(15,23,42,0.02); cursor: pointer; }
      .item:hover { background: rgba(37,99,235,0.06); border-color: rgba(37,99,235,0.25); }
      .title { font-weight: 700; }
      .meta { color: var(--muted); font-size: 12px; margin-top: 2px; }
      .pill { display: inline-flex; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--line); color: var(--muted); font-size: 12px; background: #fff; }
      .pill.active { border-color: rgba(37,99,235,0.35); color: #1d4ed8; background: rgba(37,99,235,0.08); }

      .nodeGroup { padding: 10px 12px; border: 1px solid var(--line); border-radius: 12px; background: #fff; }
      .nodeGroup.active { outline: 2px solid rgba(37,99,235,0.35); }
      .nodeRule { padding: 10px 12px; border: 1px solid var(--line); border-radius: 12px; background: rgba(15,23,42,0.02); }
      .indent { margin-left: 12px; border-left: 2px solid rgba(15,23,42,0.08); padding-left: 10px; margin-top: 10px; }
      .smallBtn { padding: 6px 8px; border-radius: 8px; font-size: 12px; }
      label { display: block; color: var(--muted); font-size: 12px; margin: 8px 0 2px; }
      .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
      details > summary { cursor: pointer; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div>
          <h1>Filtros</h1>
          <div class="muted" id="subtitle"></div>
        </div>
        <div class="row">
          <button id="btnCancel" type="button">Cancelar</button>
          <button class="primary" id="btnSave" type="button">Guardar</button>
        </div>
      </div>

      <div class="row" style="margin-top: 12px;">
        <button id="btnLoad" type="button">Cargar campos</button>
        <div class="col muted">Tip: selecciona un grupo y agrega reglas o subgrupos.</div>
        <button id="btnAddGroup" type="button">Agregar grupo</button>
        <button id="btnAddRule" type="button">Agregar regla</button>
        <button class="danger" id="btnClearAll" type="button">Quitar todo</button>
      </div>

      <div id="msg"></div>

      <div class="grid2" style="margin-top: 12px;">
        <div class="panel">
          <div class="panelTitle">Campos</div>
          <input id="q" placeholder="Buscar campo (ej: date, partner, amount, state)" />
          <div class="scroll">
            <div class="list" id="fields"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panelTitle">Constructor visual</div>
          <div class="row" style="justify-content:space-between;">
            <div class="row" style="gap:8px;">
              <span class="pill" id="activeGroupPill">Grupo activo</span>
              <span class="muted" id="activeGroupMeta"></span>
            </div>
            <button class="smallBtn" id="btnSelectRoot" type="button">Ir al root</button>
          </div>
          <div class="hint">Hace click en un campo para agregarlo al grupo activo. Dentro de cada grupo podes elegir AND/OR.</div>
          <div id="tree" style="margin-top:10px;"></div>

          <div class="sep" style="height:1px;background:var(--line);margin:12px 0;"></div>
          <div class="panelTitle">Preview domain</div>
          <textarea id="domainPreview" readonly></textarea>
          <details style="margin-top:10px;">
            <summary class="title">Modo avanzado (JSON)</summary>
            <div class="hint">Si tu filtro es complejo (NOT, operadores raros), edita el JSON directamente.</div>
            <textarea id="domainAdvanced" placeholder='[["active","=",true]]'></textarea>
            <div class="row" style="margin-top:8px;">
              <label class="row" style="gap:8px; margin:0;"><input type="checkbox" id="useAdvanced" /> Usar avanzado</label>
              <div class="col"></div>
              <button class="smallBtn" id="btnCopy" type="button">Copiar JSON</button>
            </div>
          </details>
        </div>
      </div>
    </div>

    <script>
      const INITIAL = JSON.parse("<?= initialJson ?>");
      const $ = (id) => document.getElementById(id);

      let allFields = [];
      let loaded = false;

      // Visual builder tree: Group(op: AND|OR, children: [Group|Rule])
      let root = null;
      let activeGroupId = "";

      function setMsg(kind, text) {
        const el = $("msg");
        el.innerHTML = "";
        if (!text) return;
        const d = document.createElement("div");
        d.className = "msg " + (kind === "ok" ? "ok" : "err");
        d.textContent = text;
        el.appendChild(d);
      }

      function safeCopyToClipboard(text) {
        const t = String(text || "");
        if (!t) return false;
        try {
          if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(t);
            return true;
          }
        } catch (_) {}
        try {
          const ta = document.createElement("textarea");
          ta.value = t;
          ta.style.position = "fixed";
          ta.style.left = "-1000px";
          ta.style.top = "-1000px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        } catch (_) {
          return false;
        }
      }

      function uid() {
        return Math.random().toString(16).slice(2) + Date.now().toString(16);
      }

      function fieldByName(name) {
        return allFields.find((f) => f.fieldName === name) || null;
      }

      const MAX_DEPTH = 3; // root + 2 niveles

      function newGroup(op) {
        return { kind: "group", id: uid(), op: op || "AND", children: [] };
      }

      function newRule(fieldName) {
        const f = fieldName ? fieldByName(fieldName) : null;
        const type = f ? (f.type || "") : "";
        const ops = opsForField(f || { type });
        const op = (ops[0] && ops[0].id) ? ops[0].id : "=";
        let value = "";
        if (type === "boolean") value = true;
        if (type === "selection" && f && f.selection && f.selection.length) value = f.selection[0].value;
        return { kind: "rule", id: uid(), fieldName: fieldName || "", type, op, value };
      }

      function findNode(node, id) {
        if (!node) return null;
        if (node.id === id) return node;
        if (node.kind === "group") {
          for (const ch of node.children || []) {
            const r = findNode(ch, id);
            if (r) return r;
          }
        }
        return null;
      }

      function findParent(node, childId, parent) {
        if (!node) return null;
        if (node.id === childId) return parent || null;
        if (node.kind === "group") {
          for (const ch of node.children || []) {
            const r = findParent(ch, childId, node);
            if (r) return r;
          }
        }
        return null;
      }

      function depthOf(node, id, depth) {
        if (!node) return -1;
        if (node.id === id) return depth || 1;
        if (node.kind === "group") {
          for (const ch of node.children || []) {
            const d = depthOf(ch, id, (depth || 1) + 1);
            if (d !== -1) return d;
          }
        }
        return -1;
      }

      function setActiveGroup(id) {
        const n = findNode(root, id);
        if (!n || n.kind !== "group") return;
        activeGroupId = id;
        renderTree();
      }

      function opsForField(f) {
        const t = (f && f.type) ? String(f.type) : "unknown";
        const base = [
          { id: "__set__", label: "esta seteado" },
          { id: "__empty__", label: "esta vacio" },
        ];

        if (t === "boolean") return [{ id: "=", label: "es" }].concat(base);
        if (t === "selection") return [{ id: "=", label: "es" }, { id: "!=", label: "no es" }].concat(base);
        if (t === "date" || t === "datetime") {
          return [
            { id: "=", label: "igual" },
            { id: "!=", label: "distinto" },
            { id: ">", label: ">" },
            { id: ">=", label: ">=" },
            { id: "<", label: "<" },
            { id: "<=", label: "<=" },
          ].concat(base);
        }
        if (t === "integer" || t === "float" || t === "monetary") {
          return [
            { id: "=", label: "igual" },
            { id: "!=", label: "distinto" },
            { id: ">", label: ">" },
            { id: ">=", label: ">=" },
            { id: "<", label: "<" },
            { id: "<=", label: "<=" },
            { id: "in", label: "en lista" },
            { id: "not in", label: "no en lista" },
          ].concat(base);
        }
        if (t === "many2one") {
          return [
            { id: "=", label: "id =" },
            { id: "!=", label: "id !=" },
            { id: "__name_ilike__", label: "nombre contiene" },
            { id: "__name_not_ilike__", label: "nombre NO contiene" },
          ].concat(base);
        }
        // char, text, etc.
        return [
          { id: "ilike", label: "contiene" },
          { id: "not ilike", label: "NO contiene" },
          { id: "=", label: "igual" },
          { id: "!=", label: "distinto" },
          { id: "in", label: "en lista" },
          { id: "not in", label: "no en lista" },
        ].concat(base);
      }

      function convertValue(f, op, raw) {
        const t = (f && f.type) ? String(f.type) : "unknown";
        if (op === "__set__" || op === "__empty__") return null;

        if (op === "in" || op === "not in") {
          const items = String(raw || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          if (t === "integer") return items.map((x) => Number.parseInt(x, 10)).filter((n) => Number.isFinite(n));
          if (t === "float" || t === "monetary") return items.map((x) => Number.parseFloat(x)).filter((n) => Number.isFinite(n));
          return items;
        }

        if (t === "boolean") return Boolean(raw);
        if (t === "integer") return Number.parseInt(String(raw || "0"), 10);
        if (t === "float" || t === "monetary") return Number.parseFloat(String(raw || "0"));
        if (t === "date") return String(raw || "");
        if (t === "datetime") {
          const v = String(raw || "");
          if (!v) return "";
          // datetime-local returns YYYY-MM-DDTHH:MM (or with seconds). Odoo expects "YYYY-MM-DD HH:MM:SS"
          if (v.includes("T")) {
            const parts = v.split("T");
            const d = parts[0] || "";
            const tm = (parts[1] || "").replace("Z", "");
            const hhmm = tm.length >= 5 ? tm.slice(0, 5) : tm;
            return `${d} ${hhmm}:00`;
          }
          return v;
        }
        if (t === "many2one") {
          if (op === "=" || op === "!=") return Number.parseInt(String(raw || "0"), 10);
          return String(raw || "");
        }
        if (t === "selection") return String(raw || "");
        return String(raw || "");
      }

      function ruleToDomainTerm(r) {
        const f = fieldByName(r.fieldName) || { fieldName: r.fieldName, type: r.type || "unknown" };
        const op = r.op;
        if (op === "__set__") return [r.fieldName, "!=", false];
        if (op === "__empty__") return [r.fieldName, "=", false];
        if (op === "__name_ilike__") return [r.fieldName + ".name", "ilike", String(r.value || "")];
        if (op === "__name_not_ilike__") return [r.fieldName + ".name", "not ilike", String(r.value || "")];
        const v = convertValue(f, op, r.value);
        return [r.fieldName, op, v];
      }

      function isValidRule(r) {
        if (!r || r.kind !== "rule") return false;
        if (!r.fieldName) return false;
        if (!r.op) return false;
        const hasVal = !(r.value === null || r.value === undefined) && (typeof r.value !== "string" || r.value.trim() !== "");
        if (r.op === "__set__" || r.op === "__empty__") return true;
        if ((r.op === "__name_ilike__" || r.op === "__name_not_ilike__") && !hasVal) return false;
        if (r.op === "in" || r.op === "not in") {
          const arr = convertValue(fieldByName(r.fieldName), r.op, r.value);
          return Boolean(arr && arr.length);
        }
        if (fieldByName(r.fieldName)?.type === "boolean") return true;
        return hasVal;
      }

      function emitNode(node) {
        if (!node) return [];
        if (node.kind === "rule") {
          if (!isValidRule(node)) return [];
          return [ruleToDomainTerm(node)];
        }

        const parts = [];
        for (const ch of node.children || []) {
          const out = emitNode(ch);
          if (!out || !out.length) continue;
          // out is [term] or tokens; both are fine in token-stream domain.
          if (out.length === 1 && Array.isArray(out[0]) && out[0].length === 3) parts.push(out[0]);
          else parts.push(...out);
        }

        if (!parts.length) return [];
        if (parts.length === 1) return [parts[0]];

        const opToken = String(node.op || "AND").toUpperCase() === "OR" ? "|" : "&";
        return Array(parts.length - 1).fill(opToken).concat(parts);
      }

      function computeDomainArray() {
        const toks = emitNode(root);
        // normalize: single term => [[...]]
        if (toks.length === 1 && Array.isArray(toks[0]) && toks[0].length === 3) return [toks[0]];
        // If root is AND and everything is a term, allow implicit AND: [[..],[..]]
        const onlyTerms = toks.length && toks.every((x) => Array.isArray(x) && x.length === 3);
        if (root && String(root.op || "AND").toUpperCase() === "AND" && onlyTerms) return toks;
        return toks;
      }

      function renderFields() {
        const q = String($("q").value || "").trim().toLowerCase();
        const box = $("fields");
        box.innerHTML = "";
        const items = (allFields || [])
          .filter((f) => {
            if (!q) return true;
            return String(f.fieldName || "").toLowerCase().includes(q) || String(f.label || "").toLowerCase().includes(q);
          })
          .slice(0, 250);
        if (!items.length) {
          const d = document.createElement("div");
          d.className = "muted";
          d.textContent = loaded ? "No encontre campos con esa busqueda." : "Toca Cargar campos.";
          box.appendChild(d);
          return;
        }
        for (const f of items) {
          const it = document.createElement("div");
          it.className = "item";
          it.innerHTML = `<div class="title">${escapeHtml(f.label || f.fieldName)}</div><div class="meta">${escapeHtml(f.fieldName)} | ${escapeHtml(f.type || "")}</div>`;
          it.addEventListener("click", () => {
            const g = findNode(root, activeGroupId);
            if (!g || g.kind !== "group") return;
            g.children.push(newRule(f.fieldName));
            renderTree();
          });
          box.appendChild(it);
        }
      }

      function renderNode(node, depth) {
        if (!node) return document.createElement("div");

        if (node.kind === "rule") {
          const f = node.fieldName ? fieldByName(node.fieldName) : null;
          const ops = opsForField(f || { type: node.type || "char" });
          const el = document.createElement("div");
          el.className = "nodeRule";
          el.innerHTML = `
            <div class="row" style="justify-content:space-between;">
              <div class="col">
                <div class="title">${escapeHtml(f ? (f.label || f.fieldName) : (node.fieldName || "(sin campo)"))}</div>
                <div class="meta">${escapeHtml(node.fieldName || "")} ${node.type ? "| " + escapeHtml(node.type) : ""}</div>
              </div>
              <button class="smallBtn danger" data-action="rm_rule" data-id="${escapeHtml(node.id)}" type="button">Quitar</button>
            </div>
            <div class="grid2" style="margin-top:10px;">
              <div>
                <label>Operador</label>
                <select data-action="op" data-id="${escapeHtml(node.id)}"></select>
              </div>
              <div>
                <label>Valor</label>
                <div data-slot="val" data-id="${escapeHtml(node.id)}"></div>
              </div>
            </div>
          `;

          const sel = el.querySelector('select[data-action="op"][data-id="' + node.id + '"]');
          sel.innerHTML = "";
          for (const o of ops) {
            const opt = document.createElement("option");
            opt.value = o.id;
            opt.textContent = o.label;
            sel.appendChild(opt);
          }
          if (!node.op) node.op = (ops[0] || {}).id || "=";
          sel.value = node.op;
          sel.addEventListener("change", () => {
            node.op = sel.value;
            if (node.type === "boolean") node.value = true;
            renderTree();
          });

          const slot = el.querySelector('div[data-slot="val"][data-id="' + node.id + '"]');
          slot.innerHTML = "";
          if (node.op === "__set__" || node.op === "__empty__") {
            const d = document.createElement("div");
            d.className = "muted";
            d.textContent = "No requiere valor.";
            slot.appendChild(d);
          } else if (node.type === "boolean") {
            const s = document.createElement("select");
            s.innerHTML = `<option value="true">true</option><option value="false">false</option>`;
            s.value = String(Boolean(node.value));
            s.addEventListener("change", () => (node.value = s.value === "true"));
            slot.appendChild(s);
          } else if (node.type === "selection" && f && f.selection && f.selection.length) {
            const s = document.createElement("select");
            for (const x of f.selection) {
              const opt = document.createElement("option");
              opt.value = x.value;
              opt.textContent = x.label;
              s.appendChild(opt);
            }
            s.value = String(node.value || f.selection[0].value);
            s.addEventListener("change", () => (node.value = s.value));
            slot.appendChild(s);
          } else if (node.type === "date") {
            const inp = document.createElement("input");
            inp.type = "date";
            inp.value = String(node.value || "");
            inp.addEventListener("input", () => (node.value = inp.value));
            slot.appendChild(inp);
          } else if (node.type === "datetime") {
            const inp = document.createElement("input");
            inp.type = "datetime-local";
            const cur = String(node.value || "");
            inp.value = cur.includes(" ") ? cur.replace(" ", "T").slice(0, 16) : cur;
            inp.addEventListener("input", () => (node.value = inp.value));
            slot.appendChild(inp);
          } else {
            const inp = document.createElement("input");
            inp.placeholder = (node.op === "in" || node.op === "not in") ? "separado por coma (ej: 1,2,3)" : "valor";
            inp.value = String(node.value || "");
            inp.addEventListener("input", () => (node.value = inp.value));
            slot.appendChild(inp);
          }

          return el;
        }

        const el = document.createElement("div");
        el.className = "nodeGroup" + (node.id === activeGroupId ? " active" : "");
        const depthNum = depth || 1;
        const disableAddGroup = depthNum >= MAX_DEPTH;
        el.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div class="row" style="gap:8px;">
              <span class="pill ${node.id === activeGroupId ? "active" : ""}">Grupo</span>
              <span class="meta">Nivel: ${depthNum}</span>
            </div>
            <div class="row">
              ${node.id !== root.id ? `<button class="smallBtn danger" data-action="rm_group" data-id="${escapeHtml(node.id)}" type="button">Quitar grupo</button>` : ""}
            </div>
          </div>
          <div class="grid2" style="margin-top:10px;">
            <div>
              <label>Combinar</label>
              <select data-action="group_op" data-id="${escapeHtml(node.id)}">
                <option value="AND">Todas (AND)</option>
                <option value="OR">Cualquiera (OR)</option>
              </select>
            </div>
            <div>
              <label>Acciones</label>
              <div class="row">
                <button class="smallBtn" data-action="add_rule" data-id="${escapeHtml(node.id)}" type="button">+ Regla</button>
                <button class="smallBtn" data-action="add_group" data-id="${escapeHtml(node.id)}" type="button" ${disableAddGroup ? "disabled" : ""}>+ Grupo</button>
                <button class="smallBtn" data-action="select_group" data-id="${escapeHtml(node.id)}" type="button">Seleccionar</button>
              </div>
              ${disableAddGroup ? `<div class="hint">Max nivel alcanzado.</div>` : ""}
            </div>
          </div>
        `;

        const sel = el.querySelector('select[data-action="group_op"][data-id="' + node.id + '"]');
        sel.value = String(node.op || "AND").toUpperCase() === "OR" ? "OR" : "AND";
        sel.addEventListener("change", () => {
          node.op = sel.value;
          renderTree();
        });

        const childrenBox = document.createElement("div");
        childrenBox.className = "indent";
        if (!node.children || !node.children.length) {
          const d = document.createElement("div");
          d.className = "muted";
          d.textContent = "Sin hijos. Agrega reglas o grupos.";
          childrenBox.appendChild(d);
        } else {
          for (const ch of node.children) {
            childrenBox.appendChild(renderNode(ch, depthNum + 1));
          }
        }
        el.appendChild(childrenBox);
        return el;
      }

      function renderTree() {
        const depth = depthOf(root, activeGroupId, 1);
        try {
          $("activeGroupMeta").textContent = depth > 0 ? `Nivel ${depth} de ${MAX_DEPTH}` : "";
        } catch (_) {}

        const box = $("tree");
        box.innerHTML = "";
        box.appendChild(renderNode(root, 1));

        const dom = computeDomainArray();
        $("domainPreview").value = JSON.stringify(dom);
        if (!$("useAdvanced").checked) $("domainAdvanced").value = JSON.stringify(dom, null, 0);
      }

      function escapeHtml(s) {
        return String(s || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function tryInitFromDomainString(domainStr) {
        const raw = String(domainStr || "").trim();
        if (!raw) {
          root = newGroup("AND");
          activeGroupId = root.id;
          $("domainAdvanced").value = "";
          $("useAdvanced").checked = false;
          setMsg("ok", "");
          renderTree();
          return;
        }

        function isTerm(x) {
          return Array.isArray(x) && x.length === 3 && typeof x[0] === "string" && typeof x[1] === "string";
        }

        function parseDomainToTree(rawJson) {
          const parsed = JSON.parse(rawJson);
          if (!Array.isArray(parsed)) throw new Error("Domain no es un array.");
          if (parsed.some((x) => x === "!")) throw new Error("NOT no soportado en visual.");

          // implicit AND: [[term],[term],...]
          if (parsed.every((x) => isTerm(x))) {
            const g = newGroup("AND");
            for (const t of parsed) {
              const r = newRule(String(t[0] || ""));
              r.fieldName = String(t[0] || "");
              r.op = String(t[1] || "=");
              r.value = t[2];
              g.children.push(r);
            }
            return g;
          }

          // prefix token-stream: ["&","|",term,term,term] etc
          if (!(parsed[0] === "&" || parsed[0] === "|")) throw new Error("Dominio complejo (no prefix).");

          const tokens = parsed.slice();
          let idx = 0;

          function parseExpr() {
            if (idx >= tokens.length) throw new Error("Unexpected end");
            const t = tokens[idx++];
            if (t === "&" || t === "|") {
              const left = parseExpr();
              const right = parseExpr();
              const g = newGroup(t === "|" ? "OR" : "AND");
              g.children.push(left, right);
              return g;
            }
            if (t === "!") throw new Error("NOT no soportado.");
            if (isTerm(t)) {
              const r = newRule(String(t[0] || ""));
              r.fieldName = String(t[0] || "");
              r.op = String(t[1] || "=");
              r.value = t[2];
              return r;
            }
            throw new Error("Token desconocido.");
          }

          function flatten(node) {
            if (!node || node.kind !== "group") return node;
            const kids = [];
            for (const ch of node.children || []) {
              const fc = flatten(ch);
              if (fc && fc.kind === "group" && String(fc.op || "").toUpperCase() === String(node.op || "").toUpperCase()) kids.push(...(fc.children || []));
              else kids.push(fc);
            }
            node.children = kids;
            return node;
          }

          const expr = parseExpr();
          if (idx !== tokens.length) throw new Error("Dominio complejo (extra tokens).");
          return expr.kind === "group" ? flatten(expr) : (() => { const g = newGroup("AND"); g.children = [expr]; return g; })();
        }

        try {
          const g = parseDomainToTree(raw);
          root = g;
          activeGroupId = root.id;
          $("useAdvanced").checked = false;
          $("domainAdvanced").value = raw;
          setMsg("ok", "");
          renderTree();
        } catch (e) {
          $("useAdvanced").checked = true;
          $("domainAdvanced").value = raw;
          setMsg("ok", "Dominio complejo detectado: se abre en modo avanzado.");
          // Keep a blank visual tree (not used when advanced is ON).
          root = newGroup("AND");
          activeGroupId = root.id;
          renderTree();
        }
      }

      function loadFields() {
        setMsg("ok", "");
        $("btnLoad").disabled = true;
        google.script.run
          .withSuccessHandler((res) => {
            allFields = (res || []).slice();
            loaded = true;
            renderFields();

            // Re-infer rule types now that we have fields.
            (function walk(node) {
              if (!node) return;
              if (node.kind === "rule") {
                const f = fieldByName(node.fieldName);
                if (f) node.type = f.type || node.type || "";
                if (node.type === "selection" && f && f.selection && f.selection.length && (node.value === "" || node.value === null || node.value === undefined)) {
                  node.value = f.selection[0].value;
                }
              } else if (node.kind === "group") {
                for (const ch of node.children || []) walk(ch);
              }
            })(root);

            renderTree();
            $("btnLoad").disabled = false;
          })
          .withFailureHandler((e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setMsg("err", msg);
            $("btnLoad").disabled = false;
          })
          .api_getModelFields({
            connectionId: INITIAL.connectionId,
            model: INITIAL.model,
            companyId: INITIAL.companyId,
          });
      }

      $("btnCancel").addEventListener("click", () => google.script.host.close());
      $("btnCopy").addEventListener("click", () => {
        const ok = safeCopyToClipboard($("domainAdvanced").value || $("domainPreview").value);
        setMsg(ok ? "ok" : "err", ok ? "Copiado." : "No pude copiar.");
      });
      $("btnLoad").addEventListener("click", loadFields);
      $("q").addEventListener("input", renderFields);
      $("btnSelectRoot").addEventListener("click", () => setActiveGroup(root.id));

      function addGroupTo(groupId) {
        const g = findNode(root, groupId);
        if (!g || g.kind !== "group") return;
        const depth = depthOf(root, groupId, 1);
        if (depth >= MAX_DEPTH) return setMsg("err", "Max nivel alcanzado.");
        const ng = newGroup("AND");
        g.children.push(ng);
        setActiveGroup(ng.id);
      }

      function addRuleTo(groupId) {
        const g = findNode(root, groupId);
        if (!g || g.kind !== "group") return;
        g.children.push(newRule(""));
        renderTree();
      }

      $("btnAddGroup").addEventListener("click", () => addGroupTo(activeGroupId));
      $("btnAddRule").addEventListener("click", () => addRuleTo(activeGroupId));
      $("btnClearAll").addEventListener("click", () => {
        root = newGroup("AND");
        activeGroupId = root.id;
        $("useAdvanced").checked = false;
        $("domainAdvanced").value = "";
        setMsg("ok", "");
        renderTree();
      });

      $("useAdvanced").addEventListener("change", () => {
        const on = $("useAdvanced").checked;
        if (!on) {
          // Try to convert advanced JSON into visual tree; re-enables advanced on failure.
          tryInitFromDomainString($("domainAdvanced").value || "");
        } else {
          // Keep whatever preview was computed as a starting point for manual edits.
          if (!String($("domainAdvanced").value || "").trim()) $("domainAdvanced").value = $("domainPreview").value || "";
        }
      });

      document.body.addEventListener("click", (ev) => {
        const btn = ev.target && ev.target.closest && ev.target.closest("button[data-action]");
        const action = btn ? btn.getAttribute("data-action") : "";
        const id = btn ? btn.getAttribute("data-id") : "";
        if (!action) return;
        if (action === "select_group") return setActiveGroup(id);
        if (action === "add_rule") return addRuleTo(id);
        if (action === "add_group") return addGroupTo(id);
        if (action === "rm_rule") {
          const parent = findParent(root, id, null);
          if (!parent || parent.kind !== "group") return;
          parent.children = (parent.children || []).filter((x) => x.id !== id);
          renderTree();
          return;
        }
        if (action === "rm_group") {
          if (id === root.id) return;
          const parent = findParent(root, id, null);
          if (!parent || parent.kind !== "group") return;
          parent.children = (parent.children || []).filter((x) => x.id !== id);
          if (activeGroupId === id) activeGroupId = parent.id;
          renderTree();
          return;
        }
      });

      $("btnSave").addEventListener("click", () => {
        setMsg("ok", "");
        $("btnSave").disabled = true;
        const useAdv = $("useAdvanced").checked;
        const domainStr = useAdv ? String($("domainAdvanced").value || "").trim() : JSON.stringify(computeDomainArray());
        google.script.run
          .withSuccessHandler(() => {
            google.script.host.close();
          })
          .withFailureHandler((e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setMsg("err", msg);
            $("btnSave").disabled = false;
          })
          .api_setDraftDomain({ connectionId: INITIAL.connectionId, model: INITIAL.model, domain: domainStr });
      });

      // Init
      $("subtitle").textContent = `${INITIAL.connectionTitle || ""} | ${INITIAL.model || ""}`;
      // Build initial tree from current domain (or fallback to Advanced if it's too complex).
      tryInitFromDomainString(INITIAL.currentDomain || "");
      // Load fields automatically (so selection/labels work).
      loadFields();
    </script>
  </body>
</html>

