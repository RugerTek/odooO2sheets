<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <style>
      :root {
        --bg: #ffffff;
        --panel: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --line: rgba(15, 23, 42, 0.12);
        --accent: #16a34a;
        --danger: #dc2626;
      }
      html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      .wrap { padding: 14px; }
      .top { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
      h1 { font-size: 16px; margin: 0; }
      .muted { color: var(--muted); font-size: 12px; margin-top: 2px; }
      .card { border: 1px solid var(--line); border-radius: 12px; padding: 12px; background: rgba(15,23,42,0.01); margin-top: 12px; }
      label { display: block; color: var(--muted); font-size: 12px; margin: 8px 0 2px; }
      input { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid rgba(15,23,42,0.18); border-radius: 10px; }
      button { border: 1px solid rgba(15, 23, 42, 0.14); background: rgba(15, 23, 42, 0.04); color: var(--text); padding: 10px 12px; border-radius: 10px; cursor: pointer; }
      button.primary { border-color: rgba(22,163,74,0.35); background: rgba(22,163,74,0.10); }
      button:disabled { opacity: 0.55; cursor: not-allowed; }
      .row { display: flex; gap: 10px; align-items: center; }
      .col { flex: 1; }
      .msg { margin-top: 10px; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--line); background: rgba(15,23,42,0.02); }
      .msg.ok { border-color: rgba(22,163,74,0.35); }
      .msg.err { border-color: rgba(220,38,38,0.35); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div>
          <h1>Renombrar</h1>
          <div class="muted" id="subtitle"></div>
        </div>
        <div class="row">
          <button id="btnClose" type="button">Cerrar</button>
          <button class="primary" id="btnSave" type="button">Guardar</button>
        </div>
      </div>

      <div class="card">
        <label>Nombre (opcional)</label>
        <input id="title" placeholder="Deja vacio para usar el nombre de la hoja" />
        <div class="muted" style="margin-top:6px;">Esto solo cambia el nombre mostrado en la lista.</div>
        <div id="msg"></div>
      </div>
    </div>

    <script>
      const INITIAL = JSON.parse("<?= initialJson ?>");
      const $ = (id) => document.getElementById(id);

      function setMsg(kind, text) {
        const el = $("msg");
        el.innerHTML = "";
        if (!text) return;
        const d = document.createElement("div");
        d.className = "msg " + (kind === "ok" ? "ok" : "err");
        d.textContent = text;
        el.appendChild(d);
      }

      function runServer(fnName, args, onOk, onErr) {
        const g = window.google;
        try {
          const runner = g.script.run
            .withSuccessHandler((res) => onOk && onOk(res))
            .withFailureHandler((e) => onErr && onErr(e));
          const arr = Array.isArray(args) ? args : args === undefined ? [] : [args];
          const fn = runner && runner[fnName];
          if (typeof fn !== "function") return onErr && onErr(new Error(`Missing server function: ${fnName}`));
          fn.apply(runner, arr);
        } catch (e) {
          onErr && onErr(e);
        }
      }

      function save() {
        setMsg("", "");
        const title = ($("title").value || "").trim();
        $("btnSave").disabled = true;
        runServer(
          "api_renameDatasource",
          [{ datasourceId: INITIAL.datasourceId, title }],
          () => {
            setMsg("ok", "Guardado.");
            setTimeout(() => google.script.host.close(), 400);
          },
          (e) => {
            const msg = (e && (e.message || String(e))) || "Error";
            setMsg("err", msg);
            $("btnSave").disabled = false;
          }
        );
      }

      $("btnSave").addEventListener("click", save);
      $("btnClose").addEventListener("click", () => google.script.host.close());
      $("title").addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") save();
      });

      // Init
      $("subtitle").textContent = `Hoja: ${INITIAL.sheetName} | Modelo: ${INITIAL.model}`;
      $("title").value = INITIAL.title || "";
      setTimeout(() => $("title").focus(), 50);
    </script>
  </body>
</html>

